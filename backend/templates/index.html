<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SafeScape - Enhanced Travel Safety Companion</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* === Enhanced Color Theme === */
    :root {
      --primary: #667eea;
      --primary-dark: #5a6fd8;
      --secondary: #764ba2;
      --accent: #f093fb;
      --danger: #ff6b6b;
      --success: #51cf66;
      --warning: #ffd43b;
      --info: #4dabf7;
      --dark: #2d3436;
      --light: #f8f9fa;
      --card-bg: rgba(255, 255, 255, 0.95);
      --sidebar-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: 1px solid rgba(255, 255, 255, 0.2);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --sidebar-width: 420px;
      --radius: 16px;
    }

    body.dark-mode {
      --primary: #8a9bff;
      --primary-dark: #7a8bef;
      --secondary: #9d6bd9;
      --accent: #ff9ff3;
      --dark: #f8f9fa;
      --light: #1a1d23;
      --card-bg: rgba(45, 52, 54, 0.95);
      --sidebar-bg: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    /* === Base Styles === */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--light);
      color: var(--dark);
      line-height: 1.6;
      overflow-x: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* === Header === */
    .main-header {
      background: var(--sidebar-bg);
      color: white;
      padding: 1rem 2rem;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo {
      background: rgba(255, 255, 255, 0.2);
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      backdrop-filter: blur(10px);
    }

    .brand h1 {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 0.2rem;
    }

    .brand p {
      opacity: 0.9;
      font-size: 0.9rem;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .mobile-menu-toggle {
      display: none;
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
    }

    .mobile-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--sidebar-bg);
      padding: 1rem;
      box-shadow: var(--shadow);
      z-index: 1001;
    }

    .mobile-menu.active {
      display: block;
    }

    .mobile-menu-item {
      display: block;
      width: 100%;
      margin-bottom: 0.5rem;
      text-align: left;
    }

    /* === Main Layout === */
    .app-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* === Enhanced Sidebar === */
    .main-sidebar {
      width: var(--sidebar-width);
      background: var(--card-bg);
      border-right: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
      position: relative;
      z-index: 100;
      backdrop-filter: blur(10px);
      height: 100vh;
    }

    .sidebar-content {
      padding: 1.5rem;
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .emergency-section {
      margin-top: auto !important;
      flex-shrink: 0 !important;
    }

    .section-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* === Filter Cards === */
    .filter-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0, 0, 0, 0.05);
      backdrop-filter: blur(10px);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--dark);
      font-size: 0.95rem;
    }

    .form-select, .form-input, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      background: var(--card-bg);
      color: var(--dark);
      font-size: 1rem;
      transition: var(--transition);
      font-family: inherit;
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-select:focus, .form-input:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* === Action Buttons === */
    .action-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .btn {
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: var(--dark);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }

    .btn-outline:hover {
      background: var(--primary);
      color: white;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* === Emergency Section === */
    .emergency-section {
      background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
      color: white;
      border-radius: var(--radius);
      padding: 1.5rem;
      text-align: center;
      backdrop-filter: blur(10px);
    }

    .emergency-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .sos-btn {
      background: white;
      color: var(--danger);
      font-size: 1.1rem;
      font-weight: 700;
      padding: 16px;
      border-radius: 50px;
      box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
      animation: pulse 2s infinite;
      width: 100%;
    }

    .sos-btn:hover {
      animation: none;
      transform: scale(1.05);
    }

    /* === Quick Actions === */
    .quick-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .quick-btn {
      background: var(--card-bg);
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
    }

    .quick-btn:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .quick-icon {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--primary);
    }

    /* === Map Section === */
    .map-section {
      flex: 1;
      position: relative;
      background: #f8f9fa;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* === Floating Action Buttons === */
    .fab-container {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      z-index: 1000;
    }

    .fab {
      width: 60px;
      height: 60px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 1.5rem;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .fab:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 30px rgba(102, 126, 234, 0.6);
    }

    .fab-danger {
      background: var(--danger);
    }

    /* === Stats Overview === */
    .stats-overview {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-top: 1rem;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.2);
      padding: 1rem;
      border-radius: 12px;
      text-align: center;
      backdrop-filter: blur(10px);
    }

    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.2rem;
    }

    .stat-label {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    /* === Modal Styles === */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 2rem;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
      position: relative;
      backdrop-filter: blur(10px);
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--dark);
      cursor: pointer;
      transition: var(--transition);
    }

    .modal-close:hover {
      color: var(--primary);
      transform: rotate(90deg);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--primary);
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    /* === Footer === */
    .main-footer {
      background: var(--card-bg);
      background-color: #dde0e4;
      border-top: 2px solid rgba(0, 0, 0, 0.1);
      padding: 1rem 2rem;
      text-align: center;
      color: var(--dark);
      font-size: 0.9rem;
    }

    .footer-links {
      margin-top: 0.5rem;
    }

    .footer-links a {
      color: var(--primary);
      text-decoration: none;
      margin: 0 10px;
      transition: var(--transition);
    }

    .footer-links a:hover {
      text-decoration: underline;
    }

    /* === Animations === */
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(255, 107, 107, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .shake {
      animation: shake 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    /* === Responsive Design === */
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }
      
      .main-sidebar {
        width: 100%;
        max-height: 70vh;
        height: auto !important;
        overflow-y: auto;
      }
      
      .sidebar-content {
        padding: 1rem;
        gap: 1rem;
      }
      
      .action-grid {
        grid-template-columns: 1fr;
      }
      
      .quick-actions {
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
      }
      
      .quick-btn {
        padding: 0.5rem;
        font-size: 0.8rem;
      }
      
      .emergency-section {
        position: relative !important;
        margin-top: 1rem !important;
        min-height: 180px !important;
      }
      
      .emergency-quick-actions {
        grid-template-columns: 1fr 1fr !important;
        gap: 0.3rem !important;
      }
      
      .header-actions {
        display: none;
      }

      .mobile-menu-toggle {
        display: block;
      }

      .fab-container {
        bottom: 1rem;
        right: 1rem;
      }

      .main-header {
        padding: 1rem;
      }

      .brand h1 {
        font-size: 1.4rem;
      }

      .sidebar-content {
        padding: 1rem;
      }

      .main-footer {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
      }

      .footer-links {
        margin-top: 0.25rem;
      }

      .footer-links a {
        margin: 0 5px;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      .filter-card {
        padding: 1rem;
      }

      .btn {
        padding: 12px 16px;
        font-size: 0.9rem;
      }

      .modal-content {
        padding: 1.5rem;
        margin: 1rem;
      }

      .main-header {
        padding: 0.75rem;
      }

      .brand h1 {
        font-size: 1.2rem;
      }

      .brand p {
        font-size: 0.8rem;
      }

      .main-footer {
        padding: 0.5rem;
        font-size: 0.8rem;
      }

      .footer-links a {
        display: block;
        margin: 0.25rem 0;
        font-size: 0.75rem;
      }
    }

    /* === Enhanced Quick Actions === */
    .quick-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    .quick-btn {
      background: var(--card-bg);
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 0.75rem;
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
      font-size: 0.85rem;
    }

    .quick-btn:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .quick-icon {
      font-size: 1.2rem;
      margin-bottom: 0.4rem;
      color: var(--primary);
    }

    /* === Emergency Section Enhancements === */
    .emergency-section {
      background: linear-gradient(135deg, #ff6b6b, #ff8e8e) !important;
      color: white !important;
      border-radius: var(--radius) !important;
      padding: 1rem !important;
      text-align: center !important;
      backdrop-filter: blur(10px) !important;
      position: sticky !important;
      bottom: 0 !important;
      overflow: visible !important;
      margin-top: auto !important;
      flex-shrink: 0 !important;
      z-index: 100 !important;
      min-height: 200px !important;
      display: block !important;
    }

    .emergency-section::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: emergencyPulse 3s ease-in-out infinite;
    }

    @keyframes emergencyPulse {
      0%, 100% { transform: scale(0.8); opacity: 0.5; }
      50% { transform: scale(1.2); opacity: 0.2; }
    }

    .emergency-quick-actions button {
      font-weight: 600;
      border: 2px solid rgba(255,255,255,0.3);
      backdrop-filter: blur(5px);
    }

    .emergency-quick-actions button:hover {
      border-color: rgba(255,255,255,0.8);
      transform: scale(1.05);
    }

    .emergency-features {
      position: relative;
      z-index: 2;
    }

    .emergency-status {
      animation: statusBlink 2s infinite;
    }

    @keyframes statusBlink {
      0%, 50% { opacity: 1; }
       51%, 100% { opacity: 0.7; }
    }

    /* === Contact Cards === */
    .contact-card {
      transition: var(--transition);
    }

    .contact-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .contact-card button:hover {
      transform: scale(1.05);
    }

    /* === Accessibility Features === */
    .accessibility-feature {
      transition: var(--transition);
    }

    .accessibility-feature:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    /* === Tip Categories === */
    .tip-category {
      transition: var(--transition);
    }

    .tip-category:hover {
      transform: translateY(-1px);
    }

    /* === Custom Scrollbar === */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* === Status Indicators === */
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-safe { background: var(--success); }
    .status-warning { background: var(--warning); }
    .status-danger { background: var(--danger); }

    /* === Route Instructions === */
    .route-instructions {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1rem;
      margin-top: 1rem;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid rgba(0,0,0,0.1);
      box-shadow: var(--shadow);
    }

    .instruction-item {
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .instruction-item:last-child {
      border-bottom: none;
    }

    .instruction-icon {
      color: var(--primary);
      font-size: 0.9rem;
      margin-top: 0.2rem;
    }

    /* === Checkbox Styles === */
    .checkbox-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      padding: 0.3rem 0;
    }

    .checkbox-label input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
    }

    /* === Loading Spinner === */
    .spinner {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* === Toast Notifications === */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--dark);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      z-index: 3000;
      transition: transform 0.3s ease;
      font-weight: 500;
      max-width: 80%;
      text-align: center;
      pointer-events: none;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    /* === Safety Level Indicators === */
    .safety-level {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    .safety-low { background: var(--success); color: white; }
    .safety-medium { background: var(--warning); color: var(--dark); }
    .safety-high { background: var(--danger); color: white; }

    /* === Custom Marker Styles === */
    .user-marker {
      background: var(--primary);
      border: 3px solid white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .safe-spot-marker {
      background: white;
      border: 2px solid var(--success);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .report-marker {
      background: var(--danger);
      color: white;
      border: 2px solid white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    /* === New Features Styles === */
    .weather-widget {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1rem;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .safety-heatmap {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1rem;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .trip-planner {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .community-score {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(102, 126, 234, 0.1);
      border-radius: var(--radius);
    }

    .score-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
    }

    .score-label {
      font-size: 0.9rem;
      color: var(--dark);
      opacity: 0.8;
    }

    .battery-saver .non-essential {
      opacity: 0.5;
      pointer-events: none;
    }

    .touch-device .btn, .touch-device .fab, .touch-device .quick-btn {
      min-height: 44px;
      min-width: 44px;
    }

    /* === Switch Toggle === */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--primary);
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    /* === Progress Bar === */
    .progress-bar {
      height: 8px;
      background-color: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }

    .progress-fill {
      height: 100%;
      background-color: var(--primary);
      transition: width 0.3s ease;
    }

    /* === Enhanced Cards === */
    .enhanced-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0, 0, 0, 0.05);
      backdrop-filter: blur(10px);
      transition: var(--transition);
    }

    .enhanced-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    /* === User Status Indicator === */
    .user-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .status-safe { background: rgba(81, 207, 102, 0.2); color: var(--success); }
    .status-concern { background: rgba(255, 212, 59, 0.2); color: var(--warning); }
    .status-emergency { background: rgba(255, 107, 107, 0.2); color: var(--danger); }

    /* === Interactive Elements === */
    .interactive-element {
      cursor: pointer;
      transition: var(--transition);
    }

    .interactive-element:hover {
      transform: scale(1.05);
    }

    /* === Advanced Form Elements === */
    .form-range {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #e9ecef;
      outline: none;
      -webkit-appearance: none;
    }

    .form-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
    }

    .form-range::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: none;
    }

    /* === Enhanced Map Controls === */
    .map-controls {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .map-control-btn {
      width: 40px;
      height: 40px;
      background: var(--card-bg);
      border: none;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: var(--dark);
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: var(--transition);
    }

    .map-control-btn:hover {
      background: var(--primary);
      color: white;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="main-header">
    <div class="logo-section">
      <div class="logo">
        <i class="fas fa-shield-alt"></i>
      </div>
      <div class="brand">
        <h1>SafeScape</h1>
        <p>Your Enhanced Travel Safety Companion</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn btn-outline" id="reportsBtn">
        <i class="fas fa-list-alt"></i> Reports
      </button>
      <button class="btn btn-outline" id="profileBtn">
        <i class="fas fa-user"></i> Profile
      </button>
      <button class="btn btn-outline" id="themeToggle">
        <i class="fas fa-moon"></i> Dark Mode
      </button>
    </div>
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
      <i class="fas fa-bars"></i>
    </button>
    <div class="mobile-menu" id="mobileMenu">
      <button class="btn btn-outline mobile-menu-item" id="mobileReportsBtn">
        <i class="fas fa-list-alt"></i> Reports
      </button>
      <button class="btn btn-outline mobile-menu-item" id="mobileProfileBtn">
        <i class="fas fa-user"></i> Profile
      </button>
      <button class="btn btn-outline mobile-menu-item" id="mobileThemeToggle">
        <i class="fas fa-moon"></i> Dark Mode
      </button>
    </div>
  </header>

  <!-- Main App Container -->
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="main-sidebar">
      <div class="sidebar-content">
        <!-- User Status -->
        <div class="filter-card">
          <h2 class="section-title">
            <i class="fas fa-user-check"></i>
            Safety Status
          </h2>
          <div class="user-status status-safe" id="userStatusDisplay">
            <i class="fas fa-check-circle"></i>
            <span>You are currently safe</span>
          </div>
          <div class="form-group">
            <div class="form-label">Update Status</div>
            <div style="display: flex; gap: 1rem;">
              <button class="btn btn-success" id="statusSafe">
                <i class="fas fa-check"></i> Safe
              </button>
              <button class="btn btn-warning" id="statusConcern">
                <i class="fas fa-exclamation"></i> Concern
              </button>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Share Live Location With</label>
            <input type="text" class="form-input" id="emergencyContact" placeholder="Enter phone number or email">
            <button class="btn btn-outline" style="margin-top: 0.5rem; width: 100%;" id="shareLiveLocation">
              <i class="fas fa-share-alt"></i> Start Sharing
            </button>
          </div>
        </div>

        <!-- Trip Planning -->
        <div class="trip-planner">
          <h2 class="section-title">
            <i class="fas fa-plane"></i>
            Trip Planning
          </h2>
          <div class="form-group">
            <label class="form-label">Destination</label>
            <input type="text" class="form-input" id="tripDestination" placeholder="Where are you going?">
          </div>
          <div class="form-group">
            <label class="form-label">Travel Dates</label>
            <div style="display: flex; gap: 0.5rem;">
              <input type="date" class="form-input" id="tripStartDate">
              <input type="date" class="form-input" id="tripEndDate">
            </div>
          </div>
          <button class="btn btn-primary" id="planTripBtn" style="width: 100%;">
            <i class="fas fa-map-marked-alt"></i> Plan My Trip
          </button>
        </div>

        <!-- Route Planning -->
        <div class="filter-card">
          <h2 class="section-title">
            <i class="fas fa-route"></i>
            Plan Safe Route
          </h2>
          <div class="form-group">
            <label class="form-label">From</label>
            <input type="text" class="form-input" id="routeFrom" placeholder="Current location" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">To</label>
            <input type="text" class="form-input" id="routeTo" placeholder="Enter destination">
          </div>
          <div class="form-group">
            <label class="form-label">Safety Preferences</label>
            <select class="form-select" id="safetyPreference">
              <option value="safest">Safest Route (Well-lit, populated areas)</option>
              <option value="balanced">Balanced (Safety + Time)</option>
              <option value="accessible">Accessibility Focused</option>
              <option value="fastest">Fastest Route</option>
            </select>
          </div>
          <button class="btn btn-primary" id="planRouteBtn" style="width: 100%;">
            <i class="fas fa-map-signs"></i> Plan Route
          </button>
        </div>

        <!-- Find Safe Spots -->
        <div class="filter-card">
          <h2 class="section-title">
            <i class="fas fa-search-location"></i>
            Find Safe Spots
          </h2>
          <div class="form-group">
            <label class="form-label">City</label>
            <select class="form-select" id="citySelect">
              <option value="">üåç All Cities</option>
              <option value="delhi">üèõÔ∏è Delhi NCR</option>
              <option value="mumbai">üåä Mumbai</option>
              <option value="bangalore">üíª Bangalore</option>
              <option value="jaipur">üè∞ Jaipur</option>
              <option value="lucknow">‚öîÔ∏è Lucknow</option>
              <option value="gurugram">üè¢ Gurugram</option>
              <option value="pune">üéì Pune</option>
              <option value="hyderabad">üíé Hyderabad</option>
              <option value="chennai">üèõÔ∏è Chennai</option>
              <option value="kolkata">üé≠ Kolkata</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Category</label>
            <select class="form-select" id="typeFilter">
              <option value="">üîç All Categories</option>
              <option value="emergency">üö® Emergency Services</option>
              <option value="medical">üè• Medical Facilities</option>
              <option value="transport">üöá Transport Hubs</option>
              <option value="accommodation">üè® Safe Accommodation</option>
              <option value="food">üçΩÔ∏è Food & Dining</option>
              <option value="shopping">üõçÔ∏è Shopping Centers</option>
              <option value="education">üéì Educational Institutes</option>
              <option value="worship">üïå Places of Worship</option>
              <option value="recreation">üé™ Recreation Centers</option>
              <option value="government">üèõÔ∏è Government Offices</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Distance Range</label>
            <select class="form-select" id="distanceFilter">
              <option value="1">üìç Within 1 km</option>
              <option value="2" selected>üìç Within 2 km</option>
              <option value="5">üìç Within 5 km</option>
              <option value="10">üìç Within 10 km</option>
              <option value="25">üìç Within 25 km</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Accessibility Features</label>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="wheelchair_access"> ‚ôø Wheelchair
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="parking_available"> üÖøÔ∏è Parking
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="24x7_available"> üïí 24/7 Open
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="female_friendly"> üë© Women Safe
              </label>
            </div>
          </div>
          <div class="action-grid">
            <button class="btn btn-primary" id="nearbyBtn">
              <i class="fas fa-search"></i> Find Spots
            </button>
            <button class="btn btn-secondary" id="nearestBtn">
              <i class="fas fa-location-arrow"></i> Nearest
            </button>
          </div>
          <div class="action-grid" style="margin-top: 0.5rem;">
            <button class="btn btn-outline" id="filterBtn">
              <i class="fas fa-filter"></i> Advanced
            </button>
            <button class="btn btn-outline" id="saveSearchBtn">
              <i class="fas fa-bookmark"></i> Save Search
            </button>
          </div>
        </div>

        <!-- Community Safety Score -->
        <div class="filter-card">
          <h2 class="section-title">
            <i class="fas fa-chart-line"></i>
            Community Safety
          </h2>
          <div class="community-score">
            <div>
              <div class="score-label">Area Safety Score</div>
              <div class="score-value" id="safetyScore">85</div>
            </div>
            <div style="text-align: right;">
              <div class="score-label">Active Reports</div>
              <div class="score-value" id="activeReports">12</div>
            </div>
          </div>
          <button class="btn btn-outline" style="width: 100%; margin-top: 1rem;" id="viewSafetyMap">
            <i class="fas fa-map"></i> View Safety Heatmap
          </button>
        </div>

        <!-- Quick Actions -->
        <div class="filter-card">
          <h2 class="section-title">
            <i class="fas fa-bolt"></i>
            Quick Actions
          </h2>
          <div class="quick-actions">
            <div class="quick-btn" id="contactsBtn">
              <div class="quick-icon">
                <i class="fas fa-phone-alt"></i>
              </div>
              <div>Emergency Contacts</div>
            </div>
            <div class="quick-btn" id="safetyTipsBtn">
              <div class="quick-icon">
                <i class="fas fa-lightbulb"></i>
              </div>
              <div>Safety Tips</div>
            </div>
            <div class="quick-btn" id="reportHazardBtn">
              <div class="quick-icon">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <div>Report Hazard</div>
            </div>
            <div class="quick-btn" id="accessibilityBtn">
              <div class="quick-icon">
                <i class="fas fa-wheelchair"></i>
              </div>
              <div>Accessibility</div>
            </div>
            <div class="quick-btn" id="panicModeBtn">
              <div class="quick-icon">
                <i class="fas fa-shield-alt"></i>
              </div>
              <div>Panic Mode</div>
            </div>
            <div class="quick-btn" id="safeRouteBtn">
              <div class="quick-icon">
                <i class="fas fa-route"></i>
              </div>
              <div>Safe Route</div>
            </div>
            <div class="quick-btn" id="nearbyHelpBtn">
              <div class="quick-icon">
                <i class="fas fa-hands-helping"></i>
              </div>
              <div>Nearby Help</div>
            </div>
            <div class="quick-btn" id="checkInBtn">
              <div class="quick-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <div>Safety Check-in</div>
            </div>
          </div>
        </div>

        <!-- Emergency Section -->
        <div style="background: linear-gradient(135deg, #ff6b6b, #ff8e8e); color: white; border-radius: 16px; padding: 1rem; text-align: center; position: relative; z-index: 10; margin-top: auto;">
          <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem;">
            üö® Emergency Assistance
          </div>
          <button class="btn sos-btn" id="sosBtn" style="background: white; color: #ff6b6b; font-size: 1rem; font-weight: 700; padding: 12px; border-radius: 50px; box-shadow: 0 4px 15px rgba(255,107,107,0.4); animation: pulse 2s infinite; width: 100%; border: none; cursor: pointer;">
            <i class="fas fa-bell"></i> SOS ALERT
          </button>
          
          <!-- Emergency Quick Actions -->
          <div style="margin: 0.75rem 0; display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem;">
            <button onclick="window.callEmergencyService('100', 'Police')" style="background: rgba(220,53,69,0.9); color: white; border: none; padding: 6px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; position: relative; z-index: 20;" onmouseover="this.style.background='#dc3545'" onmouseout="this.style.background='rgba(220,53,69,0.9)'">
              <i class="fas fa-shield-alt"></i> Police
            </button>
            <button onclick="window.callEmergencyService('108', 'Ambulance')" style="background: rgba(40,167,69,0.9); color: white; border: none; padding: 6px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; position: relative; z-index: 20;" onmouseover="this.style.background='#28a745'" onmouseout="this.style.background='rgba(40,167,69,0.9)'">
              <i class="fas fa-ambulance"></i> Ambulance
            </button>
            <button onclick="window.callEmergencyService('101', 'Fire')" style="background: rgba(255,193,7,0.9); color: #212529; border: none; padding: 6px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; position: relative; z-index: 20;" onmouseover="this.style.background='#ffc107'" onmouseout="this.style.background='rgba(255,193,7,0.9)'">
              <i class="fas fa-fire-extinguisher"></i> Fire
            </button>
            <button onclick="window.callEmergencyService('1091', 'Women Help')" style="background: rgba(23,162,184,0.9); color: white; border: none; padding: 6px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; position: relative; z-index: 20;" onmouseover="this.style.background='#17a2b8'" onmouseout="this.style.background='rgba(23,162,184,0.9)'">
              <i class="fas fa-female"></i> Women
            </button>
          </div>
          
          <!-- Emergency Features -->
          <div style="margin: 0.75rem 0; font-size: 0.75rem;">
            <div style="display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.3rem;">
              <i class="fas fa-location-arrow" style="color: white; width: 12px;"></i>
              <span>Auto Location Sharing</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.3rem;">
              <i class="fas fa-volume-up" style="color: white; width: 12px;"></i>
              <span>Audio Recording</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.3rem;">
              <i class="fas fa-camera" style="color: white; width: 12px;"></i>
              <span>Photo Evidence</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.4rem;">
              <i class="fas fa-users" style="color: white; width: 12px;"></i>
              <span>Community Alert</span>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.75rem;">
            <div style="background: rgba(255,255,255,0.2); padding: 0.5rem; border-radius: 8px; backdrop-filter: blur(10px);">
              <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 0.2rem;" id="safeSpotsCount">25+</div>
              <div style="font-size: 0.7rem; opacity: 0.9;">Safe Spots</div>
            </div>
            <div style="background: rgba(255,255,255,0.2); padding: 0.5rem; border-radius: 8px; backdrop-filter: blur(10px);">
              <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 0.2rem;" id="responseTime">2min</div>
              <div style="font-size: 0.7rem; opacity: 0.9;">Avg Response</div>
            </div>
          </div>
          
          <!-- Emergency Status Indicator -->
          <div id="emergencyStatus" style="margin-top: 0.75rem; padding: 0.4rem; background: rgba(255,255,255,0.3); border-radius: 6px; text-align: center; font-size: 0.7rem; display: none;">
            <i class="fas fa-broadcast-tower"></i> Emergency Mode Active
          </div>
        </div>
      </div>
    </aside>

    <!-- Map Section -->
    <main class="map-section">
      <div id="map"></div>
      
      <!-- Map Controls -->
      <div class="map-controls">
        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
          <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
          <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" id="resetViewBtn" title="Reset View">
          <i class="fas fa-crosshairs"></i>
        </button>
      </div>
      
      <!-- Weather Widget -->
      <div id="weatherWidget" class="weather-widget" style="display: none;">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-sun" style="font-size: 1.5rem;"></i>
          <div>
            <div style="font-weight: 600;" id="weatherTemp">24¬∞C</div>
            <div style="font-size: 0.8rem; opacity: 0.8;" id="weatherDesc">Sunny</div>
          </div>
        </div>
      </div>
      
      <!-- Safety Heatmap Toggle -->
      <div id="safetyHeatmapToggle" class="safety-heatmap" style="display: none;">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-fire" style="font-size: 1.5rem;"></i>
          <div>
            <div style="font-weight: 600;">Safety Heatmap</div>
            <div style="font-size: 0.8rem; opacity: 0.8;">Showing risk areas</div>
          </div>
          <label class="switch" style="margin-left: auto;">
            <input type="checkbox" id="heatmapToggle">
            <span class="slider round"></span>
          </label>
        </div>
      </div>
      
      <!-- Route Instructions Panel -->
      <div id="routeInstructions" class="route-instructions" style="display: none; position: absolute; bottom: 20px; left: 20px; right: 20px; z-index: 1000;">
        <h4 style="margin-bottom: 1rem; color: var(--primary);">
          <i class="fas fa-directions"></i> Route Instructions
        </h4>
        <div id="instructionsList"></div>
        <button class="btn btn-outline" id="closeRoute" style="margin-top: 1rem; width: 100%;">
          <i class="fas fa-times"></i> Close Route
        </button>
      </div>
    </main>
  </div>

  <!-- Floating Action Buttons -->
  <div class="fab-container">
    <button class="fab fab-danger" id="quickSOS" title="Quick SOS">
      <i class="fas fa-bell"></i>
    </button>
    <button class="fab" id="reportBtn" title="Report Issue">
      <i class="fas fa-plus"></i>
    </button>
    <button class="fab" id="locationBtn" title="My Location">
      <i class="fas fa-location-arrow"></i>
    </button>
  </div>

  <!-- Footer -->
  <footer class="main-footer">
    <div class="footer-content">
      <p>¬© 2025 SafeScape | Developed by Aryan | Empowering Safe Travels</p>
      <div class="footer-links">
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Service</a>
        <a href="#">Contact Support</a>
      </div>
    </div>
  </footer>

  <!-- Report Modal -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeReportModal">&times;</button>
      <h2 class="modal-title">
        <i class="fas fa-exclamation-triangle"></i>
        Report Safety Issue
      </h2>
      
      <div class="form-group">
        <label class="form-label">Issue Type</label>
        <select class="form-select" id="issueType">
          <option value="">Select Issue Type</option>
          <option value="broken_road">üöß Broken Road/Footpath</option>
          <option value="no_streetlight">üí° No Street Light</option>
          <option value="poor_visibility">üëÅÔ∏è Poor Visibility Area</option>
          <option value="harassment_zone">‚ö†Ô∏è Harassment Prone Area</option>
          <option value="unsafe_crowd">üë• Unsafe Crowd</option>
          <option value="transport_issue">üöç Public Transport Issue</option>
          <option value="accessibility">‚ôø Accessibility Barrier</option>
          <option value="other">‚ùì Other Safety Concern</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Severity Level</label>
        <select class="form-select" id="issueSeverity">
          <option value="low">üü¢ Low - Minor inconvenience</option>
          <option value="medium">üü° Medium - Be cautious</option>
          <option value="high">üü† High - Significant risk</option>
          <option value="critical">üî¥ Critical - Immediate danger</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-textarea" id="issueDescription" rows="4" placeholder="Please describe the issue in detail... (minimum 10 characters)" maxlength="500"></textarea>
        <div id="descriptionCounter" style="font-size: 0.8rem; color: #666; text-align: right; margin-top: 0.25rem;">0/500 characters</div>
      </div>

      <div class="form-group">
        <label class="form-label">Accessibility Impact</label>
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="wheelchair"> ‚ôø Wheelchair
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="visual_impairment"> üëÅÔ∏è Visual
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="hearing_impairment"> üëÇ Hearing
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="mobility_issues"> üö∂ Mobility
          </label>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Reporter Information (Optional)</label>
        <input type="text" class="form-input" id="reporterName" placeholder="Your name (optional)">
        <input type="text" class="form-input" id="reporterContact" placeholder="Contact (phone/email) for follow-up (optional)" style="margin-top: 0.5rem;">
      </div>

      <div class="form-group">
        <label class="form-label">Location Selection</label>
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
          <button type="button" class="btn btn-outline" id="selectLocationBtn" style="flex: 1;">
            <i class="fas fa-map-marker-alt"></i> Select on Map
          </button>
          <button type="button" class="btn btn-outline" id="useCurrentLocationBtn" style="flex: 1;">
            <i class="fas fa-crosshairs"></i> Use Current
          </button>
        </div>
        <div id="reportLocation" style="padding: 1rem; background: #f8f9fa; border-radius: 8px; text-align: center; border: 2px dashed #dee2e6;">
          <i class="fas fa-map-marker-alt"></i> No location selected
        </div>
      </div>

      <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
        <button class="btn btn-outline" id="cancelReport" style="flex: 1;">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button class="btn btn-primary" id="submitReport" style="flex: 2;">
          <i class="fas fa-paper-plane"></i> Submit Report
        </button>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeProfileModal">&times;</button>
      <h2 class="modal-title">
        <i class="fas fa-user-cog"></i>
        User Profile & Settings
      </h2>

      <div class="form-group">
        <label class="form-label">Traveler Type</label>
        <select class="form-select" id="travelerType">
          <option value="solo_female">üë© Solo Female Traveler</option>
          <option value="solo_male">üë® Solo Male Traveler</option>
          <option value="family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family with Children</option>
          <option value="senior">üßì Senior Citizen</option>
          <option value="disabled">‚ôø Person with Disability</option>
          <option value="student">üéì Student</option>
          <option value="tourist">üß≥ Tourist</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Emergency Contacts</label>
        <input type="text" class="form-input" placeholder="Contact 1 - Name" id="contact1Name">
        <input type="text" class="form-input" placeholder="Phone/Email" id="contact1Info" style="margin-top: 0.5rem;">
        <input type="text" class="form-input" placeholder="Contact 2 - Name" id="contact2Name" style="margin-top: 0.5rem;">
        <input type="text" class="form-input" placeholder="Phone/Email" id="contact2Info" style="margin-top: 0.5rem;">
      </div>

      <div class="form-group">
        <label class="form-label">Accessibility Needs</label>
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="need_wheelchair"> ‚ôø Wheelchair access
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="need_elevator"> üìà Elevators required
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="need_ramps"> üõ£Ô∏è Ramps needed
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="avoid_stairs"> üö´ Avoid stairs
          </label>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Safety Preferences</label>
        <div style="display: grid; grid-template-columns: 1fr; gap: 0.5rem;">
          <label class="checkbox-label">
            <input type="checkbox" id="pref_well_lit" checked> üí° Prefer well-lit routes
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="pref_populated" checked> üë• Prefer populated areas
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="pref_main_roads"> üõ£Ô∏è Prefer main roads
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="auto_share_location"> üìç Auto-share location in emergency
          </label>
        </div>
      </div>

      <button class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;" id="saveProfileBtn">
        <i class="fas fa-save"></i> Save Profile
      </button>
    </div>
  </div>

  <!-- Reports Modal -->
  <div id="reportsModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeReportsModal">&times;</button>
      <h2 class="modal-title">
        <i class="fas fa-list-alt"></i>
        Safety Reports
      </h2>
      
      <div class="reports-controls" style="margin-bottom: 1.5rem;">
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
          <button class="btn btn-primary" id="refreshReports">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <button class="btn btn-outline" id="filterVerified">
            <i class="fas fa-check-circle"></i> Verified Only
          </button>
        </div>
        <div class="form-group">
          <input type="text" class="form-input" id="searchReports" placeholder="Search reports...">
        </div>
      </div>
      
      <div id="reportsList" style="max-height: 400px; overflow-y: auto;">
        <div style="text-align: center; padding: 2rem; color: #666;">
          <i class="fas fa-spinner spinner"></i> Loading reports...
        </div>
      </div>
      
      <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #eee;">
        <button class="btn btn-outline" id="closeReportsBtn" style="width: 100%;">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>

  <!-- Trip Planning Modal -->
  <div id="tripModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeTripModal">&times;</button>
      <h2 class="modal-title">
        <i class="fas fa-plane"></i>
        Trip Planning
      </h2>
      
      <div id="tripDetails" style="max-height: 400px; overflow-y: auto;">
        <!-- Trip details will be populated here -->
      </div>
      
      <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #eee;">
        <button class="btn btn-outline" id="closeTripBtn" style="width: 100%;">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>

  <!-- Save Indicator -->
  <div id="saveIndicator" class="toast" style="display: none; position: fixed; top: 100px; right: 20px; background: #51cf66; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000;">
    <i class="fas fa-check-circle"></i> Profile saved successfully!
  </div>

  <!-- JavaScript Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
   
  <script>
    // ========================
    // üöÄ ENHANCED SAFESCAPE APPLICATION
    // ========================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Enhanced SafeScape Application Initializing...');

        // ========================
        // üó∫Ô∏è MAP & CORE VARIABLES
        // ========================
        const map = L.map('map', {
            zoomControl: true,
            scrollWheelZoom: true,
            doubleClickZoom: true,
            dragging: true
        }).setView([20.5937, 78.9629], 5);

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Marker cluster group for better performance
        const markerCluster = L.markerClusterGroup({
            chunkedLoading: true,
            showCoverageOnHover: false,
            maxClusterRadius: 50
        });
        map.addLayer(markerCluster);

        // Hazard layer for showing reported issues
        const hazardLayer = L.layerGroup();
        map.addLayer(hazardLayer);

        // Emergency services layer
        const emergencyLayer = L.layerGroup();
        map.addLayer(emergencyLayer);

        // Safety heatmap layer
        const heatLayer = L.heatLayer([], {
            radius: 25,
            blur: 15,
            maxZoom: 17,
            gradient: {
                0.2: 'blue',
                0.4: 'cyan',
                0.6: 'lime',
                0.8: 'yellow',
                1.0: 'red'
            }
        });

        // Core application state
        let userLocation = null;
        let userMarker = null;
        let currentMarkers = [];
        let routeControl = null;
        let liveLocationInterval = null;
        let reportMarker = null;
        let isSharingLocation = false;
        let currentRoute = null;
        let hazardReports = [];
        let communityData = JSON.parse(localStorage.getItem('safescape_community') || '{}');
        let allReports = [];
        let weatherControl = null;
        let isHeatmapActive = false;

        // Privacy settings
        const privacySettings = {
            location_sharing: {
                enabled: true,
                precision: 'approximate',
                duration: 'trip',
                recipients: ['emergency_contacts']
            },
            data_retention: {
                location_history: '30days',
                hazard_reports: '1year',
                route_history: '7days'
            }
        };

        // ========================
        // üë§ USER PROFILE SYSTEM
        // ========================
        const userProfile = {
            travelerType: 'solo_female',
            emergencyContacts: [],
            accessibilityNeeds: [],
            safetyPreferences: ['pref_well_lit', 'pref_populated', 'auto_share_location'],
            liveSharing: {
                isActive: false,
                contact: '',
                lastShared: null,
                interval: null
            },
            status: 'safe',
            lastLocation: null
        };

        // ========================
        // üå§Ô∏è WEATHER INTEGRATION
        // ========================
        async function getWeatherConditions(lat, lng) {
            try {
                // Using OpenWeatherMap API (demo - replace with real API key)
                const response = await fetch(
                    `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=demo_key&units=metric`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    return {
                        temperature: data.main.temp,
                        conditions: data.weather[0].main,
                        description: data.weather[0].description,
                        visibility: data.visibility,
                        windSpeed: data.wind.speed,
                        is_night: !isDaytime(data.sys.sunrise, data.sys.sunset),
                        icon: data.weather[0].icon
                    };
                } else {
                    return getSimulatedWeather();
                }
            } catch (error) {
                console.error('Weather API error:', error);
                return getSimulatedWeather();
            }
        }

        function getSimulatedWeather() {
            const conditions = ['Clear', 'Clouds', 'Rain', 'Snow'];
            const randomCondition = conditions[Math.floor(Math.random() * conditions.length)];
            const hour = new Date().getHours();
            
            return {
                temperature: 15 + Math.random() * 20,
                conditions: randomCondition,
                description: randomCondition.toLowerCase(),
                visibility: 8000 + Math.random() * 5000,
                windSpeed: Math.random() * 10,
                is_night: hour < 6 || hour > 20,
                icon: '02d'
            };
        }

        function isDaytime(sunrise, sunset) {
            const now = Math.floor(Date.now() / 1000);
            return now > sunrise && now < sunset;
        }

        function displayWeatherWidget(weather) {
            const widget = document.getElementById('weatherWidget');
            const temp = document.getElementById('weatherTemp');
            const desc = document.getElementById('weatherDesc');
            
            if (widget && temp && desc) {
                temp.textContent = `${Math.round(weather.temperature)}¬∞C`;
                desc.textContent = weather.description;
                widget.style.display = 'block';
            }
        }

        // ========================
        // üî• SAFETY HEATMAP
        // ========================
        function toggleSafetyHeatmap() {
            const toggle = document.getElementById('heatmapToggle');
            const heatmapToggle = document.getElementById('safetyHeatmapToggle');
            
            if (toggle.checked) {
                // Show heatmap
                if (!isHeatmapActive) {
                    generateSafetyHeatmap();
                    isHeatmapActive = true;
                    heatmapToggle.style.display = 'block';
                    showToast('üî• Safety heatmap activated');
                }
            } else {
                // Hide heatmap
                if (isHeatmapActive) {
                    map.removeLayer(heatLayer);
                    isHeatmapActive = false;
                    heatmapToggle.style.display = 'none';
                    showToast('üî• Safety heatmap deactivated');
                }
            }
        }

        function generateSafetyHeatmap() {
            // Generate sample hazard data for heatmap
            const heatData = [];
            
            // Add current hazard reports
            hazardReports.forEach(report => {
                const severityWeight = {
                    'critical': 1.0,
                    'high': 0.8,
                    'medium': 0.6,
                    'low': 0.4
                };
                
                heatData.push([
                    report.lat,
                    report.lng,
                    severityWeight[report.severity] || 0.5
                ]);
            });
            
            // Add some random data for demonstration
            for (let i = 0; i < 50; i++) {
                const lat = userLocation.lat + (Math.random() - 0.5) * 0.1;
                const lng = userLocation.lng + (Math.random() - 0.5) * 0.1;
                const intensity = Math.random() * 0.8;
                heatData.push([lat, lng, intensity]);
            }
            
            heatLayer.setLatLngs(heatData);
            map.addLayer(heatLayer);
        }

        // ========================
        // üó∫Ô∏è REAL MAP INTEGRATION
        // ========================

        // Enhanced geocoding function
        async function geocodeAddress(address) {
            try {
                if (!address || address.trim() === '') return null;
                
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&addressdetails=1`
                );
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon),
                        address: data[0].display_name,
                        city: data[0].address?.city || data[0].address?.town || data[0].address?.village || 'Unknown'
                    };
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                showToast('‚ùå Address lookup failed. Please try again.');
                return null;
            }
        }

        // Reverse geocoding
        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
                );
                const data = await response.json();
                return data.display_name || 'Current Location';
            } catch (error) {
                console.error('Reverse geocoding error:', error);
                return 'Current Location';
            }
        }

        // Real routing with OSRM
        async function calculateRealRoute(start, end, profile = 'driving') {
            try {
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/${profile}/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson&steps=true`
                );
                
                if (!response.ok) throw new Error('Routing service unavailable');
                
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    return data.routes[0];
                } else {
                    throw new Error('No route found');
                }
            } catch (error) {
                console.error('OSRM routing error:', error);
                // Fallback to straight line
                return createFallbackRoute(start, end);
            }
        }

        function createFallbackRoute(start, end) {
            const distance = calculateDistanceBetweenPoints(start, end);
            return {
                distance: distance,
                duration: distance * 2,
                geometry: {
                    coordinates: [
                        [start.lng, start.lat],
                        [end.lng, end.lat]
                    ],
                    type: 'LineString'
                },
                legs: [{
                    steps: [
                        {
                            maneuver: { type: 'depart' },
                            name: 'Start',
                            distance: 0
                        },
                        {
                            maneuver: { type: 'arrive' },
                            name: 'Destination',
                            distance: distance
                        }
                    ]
                }]
            };
        }

        function getRoutingProfile(safetyPreference) {
            const profiles = {
                'safest': 'foot',
                'balanced': 'walking',
                'accessible': 'foot',
                'fastest': 'driving'
            };
            return profiles[safetyPreference] || 'driving';
        }

        // Enhanced route planning
        async function planRealRoute() {
            const destination = document.getElementById('routeTo').value.trim();
            const safetyPref = document.getElementById('safetyPreference').value;
            
            if (!destination) {
                showToast('‚ùå Please enter a destination');
                return;
            }

            if (!userLocation) {
                showToast('üìç Getting your location...');
                await getUserLocation();
            }

            const button = document.getElementById('planRouteBtn');
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner spinner"></i> Planning Route...';
                button.disabled = true;

                // Clear existing route
                if (routeControl) {
                    if (routeControl.line) map.removeLayer(routeControl.line);
                    if (routeControl.startMarker) map.removeLayer(routeControl.startMarker);
                    if (routeControl.endMarker) map.removeLayer(routeControl.endMarker);
                    routeControl = null;
                }

                // Geocode destination
                showToast('üìç Looking up destination...');
                const destinationCoords = await geocodeAddress(destination);
                
                if (!destinationCoords) {
                    throw new Error('Could not find destination. Please check the address.');
                }

                // Calculate real route
                showToast('üó∫Ô∏è Calculating safest route...');
                const route = await calculateRealRoute(
                    userLocation, 
                    destinationCoords, 
                    getRoutingProfile(safetyPref)
                );

                // Display the route
                displayRealRoute(route, userLocation, destinationCoords, safetyPref);
                
                showToast('‚úÖ Safe route planned! Check instructions below.');

            } catch (error) {
                console.error('Route planning error:', error);
                showToast('‚ùå ' + error.message);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function displayRealRoute(route, start, end, safetyPref) {
            // Convert coordinates to LatLng array
            const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
            
            const routeColor = getRouteColor(safetyPref);
            const routeLine = L.polyline(coordinates, {
                color: routeColor,
                weight: 6,
                opacity: 0.8,
                lineJoin: 'round'
            }).addTo(map);

            // Add markers
            const startIcon = L.divIcon({
                html: '<div style="background: #667eea; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 3px solid white;">üìç</div>',
                iconSize: [30, 30]
            });

            const endIcon = L.divIcon({
                html: '<div style="background: #51cf66; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 3px solid white;">üèÅ</div>',
                iconSize: [30, 30]
            });

            const startMarker = L.marker([start.lat, start.lng], { icon: startIcon })
                .addTo(map)
                .bindPopup('Start: Your Location');

            const endMarker = L.marker([end.lat, end.lng], { icon: endIcon })
                .addTo(map)
                .bindPopup(`Destination: ${end.address}`);

            routeControl = {
                line: routeLine,
                startMarker: startMarker,
                endMarker: endMarker,
                instructions: route.legs?.[0]?.steps || []
            };

            // Fit map to route
            map.fitBounds(routeLine.getBounds());

            // Show instructions
            showRealRouteInstructions(route, safetyPref, end.address);
        }

        function showRealRouteInstructions(route, safetyPref, destination) {
            const instructions = route.legs?.[0]?.steps || [];
            const list = document.getElementById('instructionsList');
            
            list.innerHTML = '';

            // Add route summary
            const summary = document.createElement('div');
            summary.className = 'instruction-item';
            summary.style.background = 'rgba(102, 126, 234, 0.1)';
            summary.style.padding = '0.75rem';
            summary.style.borderRadius = '8px';
            summary.style.marginBottom = '1rem';
            summary.innerHTML = `
                <div><strong>Route to ${destination}</strong></div>
                <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.9rem;">
                    <span>üìè ${(route.distance / 1000).toFixed(1)} km</span>
                    <span>‚è±Ô∏è ${Math.round(route.duration / 60)} min</span>
                    <span>üõ°Ô∏è ${safetyPref} route</span>
                </div>
            `;
            list.appendChild(summary);

            // Add turn-by-turn instructions
            instructions.forEach((step, index) => {
                const item = document.createElement('div');
                item.className = 'instruction-item fade-in';
                item.style.animationDelay = `${index * 0.1}s`;
                
                const instructionText = getManeuverInstruction(step.maneuver, step.name, step.distance);
                item.innerHTML = `
                    <div class="instruction-icon">${index + 1}.</div>
                    <div>${instructionText}</div>
                `;
                list.appendChild(item);
            });

            document.getElementById('routeInstructions').style.display = 'block';
        }

        function getManeuverInstruction(maneuver, roadName, distance) {
            const maneuvers = {
                'depart': 'Start from your location',
                'arrive': `Arrive at destination`,
                'turn': `Turn onto ${roadName || 'the road'}`,
                'new name': `Continue on ${roadName || 'the road'}`,
                'continue': `Continue on ${roadName || 'the road'}`,
                'fork': `Take the fork toward ${roadName || 'the road'}`,
                'merge': `Merge onto ${roadName || 'the road'}`,
                'roundabout': `Enter roundabout and take exit`
            };
            
            const baseInstruction = maneuvers[maneuver.type] || `Continue on ${roadName || 'the road'}`;
            const distanceText = distance > 0 ? ` for ${(distance / 1000).toFixed(1)}km` : '';
            
            return baseInstruction + distanceText;
        }

        // ========================
        // üß≥ TRIP PLANNING
        // ========================
        function setupTripPlanning() {
            document.getElementById('planTripBtn').addEventListener('click', planTrip);
            document.getElementById('viewSafetyMap').addEventListener('click', toggleSafetyHeatmap);
        }

        async function planTrip() {
            const destination = document.getElementById('tripDestination').value.trim();
            const startDate = document.getElementById('tripStartDate').value;
            const endDate = document.getElementById('tripEndDate').value;
            
            if (!destination) {
                showToast('‚ùå Please enter a destination');
                return;
            }

            if (!startDate || !endDate) {
                showToast('‚ùå Please select travel dates');
                return;
            }

            try {
                showToast('üß≥ Planning your trip...');
                
                // Geocode destination
                const destinationCoords = await geocodeAddress(destination);
                
                if (!destinationCoords) {
                    throw new Error('Could not find destination');
                }

                // Get safety information for destination
                const safetyInfo = await getEnhancedSafetyScore(
                    destinationCoords.lat, 
                    destinationCoords.lng
                );
                
                // Display trip details
                displayTripDetails(destination, startDate, endDate, destinationCoords, safetyInfo);
                
            } catch (error) {
                console.error('Trip planning error:', error);
                showToast('‚ùå ' + error.message);
            }
        }

        function displayTripDetails(destination, startDate, endDate, coords, safetyInfo) {
            const modal = document.getElementById('tripModal');
            const details = document.getElementById('tripDetails');
            
            const safetyLevel = getSafetyLevel(safetyInfo.score);
            
            details.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="color: var(--primary); margin-bottom: 0.5rem;">${destination}</h3>
                    <p><strong>Dates:</strong> ${formatDate(startDate)} to ${formatDate(endDate)}</p>
                    <p><strong>Location:</strong> ${coords.address}</p>
                </div>
                
                <div style="background: rgba(102, 126, 234, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.5rem;">Safety Assessment</h4>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 2rem; font-weight: 700; color: ${safetyLevel.color};">${safetyInfo.score}</div>
                        <div>
                            <div style="font-weight: 600;">${safetyLevel.emoji} ${safetyLevel.level}</div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">Based on recent reports and area data</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.5rem;">Recommended Safe Spots</h4>
                    <div style="display: grid; gap: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                            <i class="fas fa-shield-alt" style="color: #51cf66;"></i>
                            <span>Police Station - 1.2 km away</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                            <i class="fas fa-hospital" style="color: #51cf66;"></i>
                            <span>General Hospital - 2.5 km away</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                            <i class="fas fa-hotel" style="color: #51cf66;"></i>
                            <span>Safe Accommodation - 0.8 km away</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 style="margin-bottom: 0.5rem;">Safety Tips</h4>
                    <ul style="padding-left: 1.5rem;">
                        <li>Share your itinerary with emergency contacts</li>
                        <li>Save local emergency numbers</li>
                        <li>Keep your phone charged at all times</li>
                        <li>Avoid poorly lit areas after dark</li>
                        <li>Use SafeScape's SOS feature if needed</li>
                    </ul>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        // ========================
        // üèÜ COMMUNITY SAFETY SCORING
        // ========================
        function calculateAreaSafetyScore(lat, lng, radius = 0.5) {
            const nearbyHazards = getHazardsNearPoint(lat, lng, radius);
            const recentHazards = nearbyHazards.filter(h => {
                const daysAgo = (Date.now() - new Date(h.timestamp)) / (1000 * 60 * 60 * 24);
                return daysAgo < 7; // Last 7 days
            });
            
            let score = 100;
            recentHazards.forEach(hazard => {
                const severityWeight = { low: 2, medium: 5, high: 10, critical: 20 };
                const verificationBonus = hazard.verified ? 1.5 : 1;
                score -= severityWeight[hazard.severity] * verificationBonus;
            });
            
            // Consider time of day
            const hour = new Date().getHours();
            if (hour < 6 || hour > 20) {
                score -= 10;
            }
            
            return Math.max(0, Math.min(100, Math.round(score)));
        }

        function getSafetyLevel(score) {
            if (score >= 80) return { level: 'Very Safe', color: '#51cf66', emoji: 'üü¢' };
            if (score >= 60) return { level: 'Safe', color: '#94d82d', emoji: 'üü°' };
            if (score >= 40) return { level: 'Moderate', color: '#fcc419', emoji: 'üü†' };
            if (score >= 20) return { level: 'Caution', color: '#ff922b', emoji: 'üü†' };
            return { level: 'Unsafe', color: '#ff6b6b', emoji: 'üî¥' };
        }

        async function getEnhancedSafetyScore(lat, lng, radius = 0.5) {
            const baseScore = calculateAreaSafetyScore(lat, lng, radius);
            const timeModifier = getTimeBasedSafetyModifier();
            
            try {
                const weather = await getWeatherConditions(lat, lng);
                const weatherAdjustedScore = adjustSafetyForWeather(baseScore, weather);
                const finalScore = weatherAdjustedScore + timeModifier;
                
                return {
                    score: Math.max(0, Math.min(100, finalScore)),
                    weather: weather,
                    timeModifier: timeModifier,
                    baseScore: baseScore
                };
            } catch (error) {
                return {
                    score: Math.max(0, Math.min(100, baseScore + timeModifier)),
                    weather: null,
                    timeModifier: timeModifier,
                    baseScore: baseScore
                };
            }
        }

        function adjustSafetyForWeather(safetyScore, weather) {
            let adjustedScore = safetyScore;
            
            if (weather.is_night) adjustedScore -= 10;
            if (weather.conditions === 'Rain') adjustedScore -= 15;
            if (weather.conditions === 'Snow') adjustedScore -= 20;
            if (weather.visibility < 1000) adjustedScore -= 25;
            if (weather.windSpeed > 15) adjustedScore -= 5;
            
            return Math.max(0, adjustedScore);
        }

        function getTimeBasedSafetyModifier() {
            const hour = new Date().getHours();
            
            if (hour >= 22 || hour < 6) return -20;
            if (hour >= 18 || hour < 8) return -10;
            return 0;
        }

        // ========================
        // üéØ EXISTING FUNCTIONS (Updated)
        // ========================

        // Initialize profile from localStorage
        function loadUserProfile() {
            try {
                const saved = localStorage.getItem('safescape_profile');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    Object.assign(userProfile, parsed);
                    updateProfileUI();
                    updateStatusUI(userProfile.status);
                    console.log('‚úÖ User profile loaded:', userProfile);
                }
                
                // Load saved search preferences
                loadSavedSearchPreferences();
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }
        
        function loadSavedSearchPreferences() {
            try {
                const savedSearches = JSON.parse(localStorage.getItem('safescape_saved_searches') || '[]');
                if (savedSearches.length > 0) {
                    const lastSearch = savedSearches[0];
                    
                    // Apply last search preferences
                    if (lastSearch.city) document.getElementById('citySelect').value = lastSearch.city;
                    if (lastSearch.type) document.getElementById('typeFilter').value = lastSearch.type;
                    if (lastSearch.distance) document.getElementById('distanceFilter').value = lastSearch.distance;
                    
                    document.getElementById('wheelchair_access').checked = lastSearch.wheelchair || false;
                    document.getElementById('parking_available').checked = lastSearch.parking || false;
                    document.getElementById('24x7_available').checked = lastSearch.available24x7 || false;
                    document.getElementById('female_friendly').checked = lastSearch.femaleFriendly || false;
                }
            } catch (error) {
                console.error('Error loading saved searches:', error);
            }
        }

        function saveUserProfile() {
            try {
                localStorage.setItem('safescape_profile', JSON.stringify(userProfile));
                console.log('üíæ Profile saved');
            } catch (error) {
                console.error('Error saving profile:', error);
            }
        }

        function updateProfileUI() {
            const travelerTypeSelect = document.getElementById('travelerType');
            if (travelerTypeSelect) {
                travelerTypeSelect.value = userProfile.travelerType;
            }

            const checkboxes = ['pref_well_lit', 'pref_populated', 'pref_main_roads', 'auto_share_location'];
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = userProfile.safetyPreferences.includes(id);
                }
            });

            const accessibility = ['need_wheelchair', 'need_elevator', 'need_ramps', 'avoid_stairs'];
            accessibility.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = userProfile.accessibilityNeeds.includes(id);
                }
            });
            
            // Populate emergency contacts
            if (userProfile.emergencyContacts.length > 0) {
                const contact1 = userProfile.emergencyContacts[0];
                document.getElementById('contact1Name').value = contact1.name || '';
                document.getElementById('contact1Info').value = contact1.info || '';
                
                if (userProfile.emergencyContacts.length > 1) {
                    const contact2 = userProfile.emergencyContacts[1];
                    document.getElementById('contact2Name').value = contact2.name || '';
                    document.getElementById('contact2Info').value = contact2.info || '';
                }
            }
        }

        // Location Services
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    console.warn('Geolocation not supported');
                    userLocation = { lat: 28.6139, lng: 77.2090, city: 'Delhi' };
                    updateUserMarker();
                    resolve(userLocation);
                    return;
                }

                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date().toISOString()
                        };
                        
                        userProfile.lastLocation = userLocation;
                        updateUserMarker();
                        updateCurrentLocationDisplay();
                        
                        console.log('üìç Location acquired:', userLocation);
                        resolve(userLocation);
                    },
                    (error) => {
                        console.warn('Location error:', error);
                        
                        userLocation = { 
                            lat: 28.6139, 
                            lng: 77.2090, 
                            city: 'Delhi',
                            isDefault: true 
                        };
                        updateUserMarker();
                        updateCurrentLocationDisplay();
                        
                        showToast('‚ö†Ô∏è Using default location. Enable GPS for accurate results.');
                        resolve(userLocation);
                    },
                    options
                );
            });
        }

        function updateUserMarker() {
            if (userMarker) {
                map.removeLayer(userMarker);
            }

            const userIcon = L.divIcon({
                className: 'user-marker',
                html: '<div style="background: #667eea; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>',
                iconSize: [26, 26],
                iconAnchor: [13, 13]
            });

            userMarker = L.marker([userLocation.lat, userLocation.lng], { 
                icon: userIcon,
                zIndexOffset: 1000
            }).addTo(map);

            const popupContent = `
                <div style="text-align: center;">
                    <h4>üìç Your Location</h4>
                    <p>Lat: ${userLocation.lat.toFixed(4)}</p>
                    <p>Lng: ${userLocation.lng.toFixed(4)}</p>
                    ${userLocation.isDefault ? '<p><em>Default location</em></p>' : ''}
                </div>
            `;
            userMarker.bindPopup(popupContent);

            if (!userLocation.set) {
                map.setView([userLocation.lat, userLocation.lng], 13);
                userLocation.set = true;
            }
        }

        function updateCurrentLocationDisplay() {
            const routeFrom = document.getElementById('routeFrom');
            if (routeFrom) {
                if (userLocation.isDefault) {
                    routeFrom.value = 'Delhi (Default)';
                } else {
                    reverseGeocode(userLocation.lat, userLocation.lng)
                        .then(address => {
                            routeFrom.value = address;
                        })
                        .catch(() => {
                            routeFrom.value = 'Current Location';
                        });
                }
            }
        }

        // Enhanced Hazard reporting system with location selection
        let selectedLocation = null;
        let mapClickHandler = null;
        let isLocationSelectionMode = false;
        
        function setupReporting() {
            const reportModal = document.getElementById('reportModal');

            document.getElementById('reportBtn').addEventListener('click', openReportModal);
            document.getElementById('reportHazardBtn').addEventListener('click', openReportModal);
            document.getElementById('selectLocationBtn').addEventListener('click', enableLocationSelection);
            document.getElementById('useCurrentLocationBtn').addEventListener('click', useCurrentLocation);

            function openReportModal() {
                reportModal.classList.add('active');
                selectedLocation = null;
                isLocationSelectionMode = false;
                
                // Reset form
                resetReportForm();
                
                // Clear existing marker
                clearReportMarker();

                // Remove existing click handler
                disableLocationSelection();

                showToast('üìù Fill in the report details and select a location');
            }
            
            function resetReportForm() {
                document.getElementById('issueType').value = '';
                document.getElementById('issueSeverity').value = 'medium';
                document.getElementById('issueDescription').value = '';
                document.getElementById('reporterName').value = '';
                document.getElementById('reporterContact').value = '';
                
                const locationDiv = document.getElementById('reportLocation');
                locationDiv.innerHTML = '<i class="fas fa-map-marker-alt"></i> No location selected';
                locationDiv.style.background = '#f8f9fa';
                locationDiv.style.borderColor = '#dee2e6';
                locationDiv.style.color = 'inherit';
                
                ['wheelchair', 'visual_impairment', 'hearing_impairment', 'mobility_issues'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.checked = false;
                });
                
                // Reset location selection buttons
                const selectBtn = document.getElementById('selectLocationBtn');
                const currentBtn = document.getElementById('useCurrentLocationBtn');
                if (selectBtn) {
                    selectBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Select on Map';
                    selectBtn.classList.remove('btn-success');
                    selectBtn.classList.add('btn-outline');
                }
                if (currentBtn) {
                    currentBtn.innerHTML = '<i class="fas fa-crosshairs"></i> Use Current';
                    currentBtn.classList.remove('btn-success');
                    currentBtn.classList.add('btn-outline');
                }
            }
            
            function enableLocationSelection() {
                if (isLocationSelectionMode) {
                    disableLocationSelection();
                    return;
                }
                
                isLocationSelectionMode = true;
                const selectBtn = document.getElementById('selectLocationBtn');
                selectBtn.innerHTML = '<i class="fas fa-times"></i> Cancel Selection';
                selectBtn.classList.remove('btn-outline');
                selectBtn.classList.add('btn-warning');
                
                showToast('üó∫Ô∏è Click on the map to select the issue location');
                
                // Set up map click handler
                mapClickHandler = function(e) {
                    selectedLocation = {
                        lat: e.latlng.lat,
                        lng: e.latlng.lng
                    };
                    
                    clearReportMarker();
                    
                    reportMarker = L.marker(e.latlng, {
                        icon: L.divIcon({
                            className: 'report-marker',
                            html: '<div style="background: #ff6b6b; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 3px solid white; box-shadow: 0 3px 12px rgba(255,107,107,0.4); animation: pulse 2s infinite;">‚ö†Ô∏è</div>',
                            iconSize: [34, 34],
                            iconAnchor: [17, 17]
                        })
                    }).addTo(map)
                    .bindPopup('üìç Report location selected')
                    .openPopup();

                    updateLocationDisplay(e.latlng.lat, e.latlng.lng);
                    disableLocationSelection();
                    
                    showToast('‚úÖ Location selected! Complete the form and submit.');
                };
                
                map.on('click', mapClickHandler);
            }
            
            function useCurrentLocation() {
                if (!userLocation) {
                    showToast('üìç Getting your location...');
                    getUserLocation().then(() => {
                        if (userLocation) {
                            setReportLocation(userLocation.lat, userLocation.lng);
                        }
                    });
                    return;
                }
                
                setReportLocation(userLocation.lat, userLocation.lng);
            }
            
            function setReportLocation(lat, lng) {
                selectedLocation = { lat, lng };
                
                clearReportMarker();
                
                reportMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'report-marker',
                        html: '<div style="background: #51cf66; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 3px solid white; box-shadow: 0 3px 12px rgba(81,207,102,0.4);">üìç</div>',
                        iconSize: [34, 34],
                        iconAnchor: [17, 17]
                    })
                }).addTo(map)
                .bindPopup('üìç Current location selected for report')
                .openPopup();
                
                updateLocationDisplay(lat, lng);
                
                const currentBtn = document.getElementById('useCurrentLocationBtn');
                currentBtn.innerHTML = '<i class="fas fa-check"></i> Current Location';
                currentBtn.classList.remove('btn-outline');
                currentBtn.classList.add('btn-success');
                
                showToast('‚úÖ Current location selected!');
            }
            
            function updateLocationDisplay(lat, lng) {
                const locationDiv = document.getElementById('reportLocation');
                locationDiv.innerHTML = `<i class="fas fa-map-marker-alt" style="color: #51cf66;"></i> Location: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                locationDiv.style.background = '#e8f5e8';
                locationDiv.style.borderColor = '#51cf66';
                locationDiv.style.color = '#2d5016';
            }
            
            function disableLocationSelection() {
                if (mapClickHandler) {
                    map.off('click', mapClickHandler);
                    mapClickHandler = null;
                }
                
                isLocationSelectionMode = false;
                const selectBtn = document.getElementById('selectLocationBtn');
                if (selectBtn) {
                    selectBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Select on Map';
                    selectBtn.classList.remove('btn-warning');
                    selectBtn.classList.add('btn-outline');
                }
            }
            
            function clearReportMarker() {
                if (reportMarker) {
                    map.removeLayer(reportMarker);
                    reportMarker = null;
                }
            }

            document.getElementById('submitReport').addEventListener('click', async () => {
                const issueType = document.getElementById('issueType').value;
                const severity = document.getElementById('issueSeverity').value;
                const description = document.getElementById('issueDescription').value.trim();

                if (!issueType) {
                    showToast('‚ùå Please select an issue type');
                    return;
                }

                if (!selectedLocation || !selectedLocation.lat || !selectedLocation.lng) {
                    showToast('‚ùå Please click on the map to select a location first');
                    const locationDiv = document.getElementById('reportLocation');
                    locationDiv.style.background = '#ffe6e6';
                    locationDiv.style.borderColor = '#ff6b6b';
                    locationDiv.style.color = '#721c24';
                    locationDiv.classList.add('shake');
                    setTimeout(() => {
                        locationDiv.classList.remove('shake');
                        locationDiv.style.background = '#f8f9fa';
                        locationDiv.style.borderColor = '#dee2e6';
                        locationDiv.style.color = 'inherit';
                    }, 1000);
                    return;
                }

                if (!description) {
                    showToast('‚ùå Please provide a description of the issue');
                    return;
                }

                const accessibilityImpacts = [];
                if (document.getElementById('wheelchair').checked) accessibilityImpacts.push('wheelchair');
                if (document.getElementById('visual_impairment').checked) accessibilityImpacts.push('visual_impairment');
                if (document.getElementById('hearing_impairment').checked) accessibilityImpacts.push('hearing_impairment');
                if (document.getElementById('mobility_issues').checked) accessibilityImpacts.push('mobility_issues');

                const submitButton = document.getElementById('submitReport');
                const originalText = submitButton.innerHTML;

                try {
                    submitButton.innerHTML = '<i class="fas fa-spinner spinner"></i> Submitting...';
                    submitButton.disabled = true;

                    const hazardData = {
                        type: issueType,
                        severity: severity,
                        description: description,
                        accessibility_impacts: accessibilityImpacts,
                        lat: selectedLocation.lat,
                        lng: selectedLocation.lng,
                        timestamp: new Date().toISOString(),
                        reported_by: userProfile.travelerType
                    };
                    
                    console.log('Submitting hazard data:', hazardData);

                    // Use AI-enhanced reporting
                    const result = await submitHazardWithAI(hazardData);
                    
                    if (result.success) {
                        // Add to allReports array
                        allReports.unshift(result.hazard);
                        
                        // Update active reports count
                        document.getElementById('activeReports').textContent = allReports.length;
                        
                        showToast('‚úÖ Safety report submitted successfully! Thank you for making the area safer.');
                        
                        // Clear marker and close modal
                        if (reportMarker) {
                            map.removeLayer(reportMarker);
                            reportMarker = null;
                        }
                        selectedLocation = null;
                        
                        closeReportModal();
                    } else {
                        throw new Error('Failed to submit report');
                    }
                } catch (error) {
                    console.error('Report submission error:', error);
                    showToast('‚ùå Failed to submit report. Please check your connection and try again.');
                } finally {
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                }
            });

            document.getElementById('closeReportModal').addEventListener('click', closeReportModal);
            document.getElementById('cancelReport').addEventListener('click', closeReportModal);
            
            // Close modal when clicking outside
            reportModal.addEventListener('click', (e) => {
                if (e.target === reportModal) {
                    closeReportModal();
                }
            });

            function closeReportModal() {
                reportModal.classList.remove('active');
                
                // Remove map click handler
                if (mapClickHandler) {
                    map.off('click', mapClickHandler);
                    mapClickHandler = null;
                }
                
                // Clean up marker
                if (reportMarker) {
                    map.removeLayer(reportMarker);
                    reportMarker = null;
                }
                
                // Reset selected location
                selectedLocation = null;
                
                // Reset location display
                const locationDiv = document.getElementById('reportLocation');
                locationDiv.innerHTML = '<i class="fas fa-map-marker-alt"></i> Click on map to select location';
                locationDiv.style.background = '#f8f9fa';
                locationDiv.style.borderColor = '#dee2e6';
            }
        }

        // AI-powered hazard classification
        async function classifyHazardSeverity(description, type, location) {
            await new Promise(resolve => setTimeout(resolve, 800));
            
            const keywords = {
                critical: ['attack', 'assault', 'weapon', 'fire', 'collapse', 'emergency', 'danger'],
                high: ['harassment', 'threat', 'unsafe', 'dangerous', 'avoid', 'warning'],
                medium: ['broken', 'damaged', 'dark', 'no light', 'crowded', 'busy'],
                low: ['inconvenience', 'minor', 'annoying', 'bother']
            };
            
            const descriptionLower = description.toLowerCase();
            let severityScore = 0;
            
            keywords.critical.forEach(word => {
                if (descriptionLower.includes(word)) severityScore += 10;
            });
            keywords.high.forEach(word => {
                if (descriptionLower.includes(word)) severityScore += 6;
            });
            keywords.medium.forEach(word => {
                if (descriptionLower.includes(word)) severityScore += 3;
            });
            keywords.low.forEach(word => {
                if (descriptionLower.includes(word)) severityScore += 1;
            });
            
            const lengthFactor = Math.min(description.length / 50, 2);
            severityScore += lengthFactor;
            
            const typeWeights = {
                'harassment_zone': 8,
                'broken_road': 3,
                'no_streetlight': 4,
                'poor_visibility': 5,
                'unsafe_crowd': 6,
                'transport_issue': 3,
                'accessibility': 2,
                'other': 1
            };
            
            severityScore += typeWeights[type] || 1;
            
            let suggestedSeverity = 'low';
            if (severityScore >= 15) suggestedSeverity = 'critical';
            else if (severityScore >= 10) suggestedSeverity = 'high';
            else if (severityScore >= 5) suggestedSeverity = 'medium';
            
            return {
                severity: suggestedSeverity,
                confidence: Math.min(severityScore / 20 * 100, 100),
                factors: {
                    keyword_score: severityScore,
                    description_length: description.length,
                    type_weight: typeWeights[type] || 1
                }
            };
        }

        // Enhanced hazard reporting with AI
        async function submitHazardWithAI(hazardData) {
            showToast('ü§ñ AI analyzing hazard severity...');
            
            const aiAnalysis = await classifyHazardSeverity(
                hazardData.description,
                hazardData.type,
                { lat: hazardData.lat, lng: hazardData.lng }
            );
            
            const severityWeights = { low: 1, medium: 2, high: 3, critical: 4 };
            const userSeverityWeight = severityWeights[hazardData.severity] || 1;
            const aiSeverityWeight = severityWeights[aiAnalysis.severity] || 1;
            
            const finalSeverity = aiSeverityWeight > userSeverityWeight ? 
                                 aiAnalysis.severity : hazardData.severity;
            
            const enhancedHazardData = {
                ...hazardData,
                id: (allReports.length + 1).toString(),
                severity: finalSeverity,
                ai_analysis: aiAnalysis,
                ai_suggested_severity: aiAnalysis.severity,
                confidence: aiAnalysis.confidence,
                location: `Lat: ${hazardData.lat.toFixed(4)}, Lng: ${hazardData.lng.toFixed(4)}`,
                verified: false,
                verification_count: 1
            };
            
            showToast(`‚úÖ AI analysis complete: ${aiAnalysis.severity.toUpperCase()} risk`);
            
            // Mock API call
            return new Promise(resolve => {
                setTimeout(() => {
                    hazardReports.push(enhancedHazardData);
                    displayCommunityHazard(enhancedHazardData);
                    resolve({ success: true, hazard: enhancedHazardData });
                }, 1000);
            });
        }

        function displayCommunityHazard(hazard) {
            const severityColors = {
                'critical': '#ff6b6b',
                'high': '#ffa94d',
                'medium': '#ffd43b',
                'low': '#51cf66'
            };

            const icon = L.divIcon({
                className: 'hazard-marker',
                html: `
                    <div style="
                        background: ${severityColors[hazard.severity]}; 
                        color: white; 
                        width: ${hazard.verified ? '28px' : '24px'}; 
                        height: ${hazard.verified ? '28px' : '24px'}; 
                        border-radius: 50%; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        font-size: 12px; 
                        border: 3px solid white; 
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        ${hazard.verified ? 'animation: pulse 2s infinite;' : ''}
                    ">
                        ‚ö†Ô∏è
                    </div>
                `,
                iconSize: [hazard.verified ? 34 : 30, hazard.verified ? 34 : 30],
                iconAnchor: [hazard.verified ? 17 : 15, hazard.verified ? 17 : 15]
            });

            const marker = L.marker([hazard.lat, hazard.lng], { icon: icon })
                .addTo(hazardLayer)
                .bindPopup(`
                    <div style="min-width: 250px;">
                        <h4>${getIssueTypeDisplay(hazard.type)} 
                            ${hazard.verified ? '<span style="color: #51cf66;">‚úì Verified</span>' : ''}
                        </h4>
                        <p><strong>Severity:</strong> 
                            <span style="color: ${severityColors[hazard.severity]}">
                                ${hazard.severity.toUpperCase()}
                            </span>
                        </p>
                        <p>${hazard.description}</p>
                        <p><strong>Verified by:</strong> ${hazard.verification_count || 0} users</p>
                        <p><em>Reported ${formatTimeAgo(hazard.timestamp)}</em></p>
                        <div style="margin-top: 10px;">
                            <button onclick="verifyHazardReport('${hazard.id}')" 
                                    style="background: #667eea; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-right: 5px;">
                                <i class="fas fa-check"></i> Confirm
                            </button>
                            <button onclick="showEnhancedSafetyInfo(${hazard.lat}, ${hazard.lng})" 
                                    style="background: #51cf66; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-chart-line"></i> Area Safety
                            </button>
                        </div>
                    </div>
                `);

            marker.hazardId = hazard.id;
            return marker;
        }

        function formatTimeAgo(timestamp) {
            const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
            
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            return Math.floor(seconds / 86400) + ' days ago';
        }

        // Safe spots and services
        async function findNearbySpots() {
            if (!userLocation) {
                showToast('üìç Getting your location...');
                await getUserLocation();
            }

            const button = document.getElementById('nearbyBtn');
            const originalText = button.innerHTML;

            try {
                button.innerHTML = '<i class="fas fa-spinner spinner"></i> Searching...';
                button.disabled = true;

                showToast('üîç Finding safe spots near you...');
                
                // Generate comprehensive safe spots
                const spots = generateComprehensiveSafeSpots();
                
                // Apply filters
                const filteredSpots = applyAccessibilityFilters(spots);
                
                displaySafeSpots(filteredSpots);
                
                const count = filteredSpots.length;
                showToast(`‚úÖ Found ${count} safe spots in your area`);
                
            } catch (error) {
                console.error('Error fetching safe spots:', error);
                showToast('‚ùå Error loading safe spots. Please try again.');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        function applyAccessibilityFilters(spots) {
            let filtered = [...spots];
            
            if (document.getElementById('wheelchair_access').checked) {
                filtered = filtered.filter(spot => spot.wheelchair_accessible);
            }
            if (document.getElementById('parking_available').checked) {
                filtered = filtered.filter(spot => spot.parking_available);
            }
            if (document.getElementById('24x7_available').checked) {
                filtered = filtered.filter(spot => spot.available_24x7);
            }
            if (document.getElementById('female_friendly').checked) {
                filtered = filtered.filter(spot => spot.female_friendly);
            }
            
            return filtered;
        }

        function generateComprehensiveSafeSpots() {
            const categories = {
                emergency: [
                    { name: "Central Police Station", contact: "100", services: ["24/7 Emergency", "Women Help Desk", "Cyber Crime"] },
                    { name: "Fire Station", contact: "101", services: ["Fire Emergency", "Rescue Operations", "Ambulance"] },
                    { name: "Women Police Station", contact: "1091", services: ["Women Safety", "Domestic Violence", "Harassment Cases"] },
                    { name: "Traffic Police Post", contact: "103", services: ["Traffic Control", "Accident Help", "Vehicle Issues"] }
                ],
                medical: [
                    { name: "City General Hospital", contact: "108", services: ["Emergency Care", "Trauma Center", "Ambulance"] },
                    { name: "Apollo Hospital", contact: "+91-11-26925858", services: ["Multi-specialty", "24/7 Emergency", "ICU"] },
                    { name: "Max Healthcare", contact: "+91-11-26692251", services: ["Super Specialty", "Emergency", "Pharmacy"] },
                    { name: "AIIMS Hospital", contact: "+91-11-26588500", services: ["Government Hospital", "All Specialties", "Emergency"] },
                    { name: "Local Clinic", contact: "+91-98765-43210", services: ["Primary Care", "First Aid", "Consultation"] },
                    { name: "24/7 Pharmacy", contact: "+91-98765-43211", services: ["Medicines", "Emergency Drugs", "Health Products"] }
                ],
                transport: [
                    { name: "Central Railway Station", contact: "139", services: ["Train Services", "Waiting Room", "Security"] },
                    { name: "Metro Station", contact: "155370", services: ["Metro Services", "CCTV Monitoring", "Help Desk"] },
                    { name: "Bus Terminal", contact: "+91-11-23386833", services: ["Bus Services", "Waiting Area", "Information"] },
                    { name: "Airport", contact: "+91-124-3376000", services: ["Flight Services", "Security", "Medical Aid"] },
                    { name: "Taxi Stand", contact: "+91-98765-43212", services: ["Licensed Taxis", "Pre-paid Service", "Safe Transport"] }
                ],
                accommodation: [
                    { name: "Hotel Taj", contact: "+91-11-66001234", services: ["Luxury Stay", "24/7 Security", "Concierge"] },
                    { name: "Budget Inn", contact: "+91-98765-43213", services: ["Affordable Stay", "Clean Rooms", "Safe Environment"] },
                    { name: "Youth Hostel", contact: "+91-98765-43214", services: ["Budget Accommodation", "Shared Facilities", "Backpacker Friendly"] },
                    { name: "Guest House", contact: "+91-98765-43215", services: ["Home Stay", "Local Experience", "Family Friendly"] }
                ],
                food: [
                    { name: "McDonald's", contact: "+91-98765-43216", services: ["Fast Food", "Clean Environment", "Family Dining"] },
                    { name: "Local Restaurant", contact: "+91-98765-43217", services: ["Regional Cuisine", "Hygienic Food", "Affordable"] },
                    { name: "Coffee Shop", contact: "+91-98765-43218", services: ["Beverages", "WiFi", "Safe Space"] },
                    { name: "Food Court", contact: "+91-98765-43219", services: ["Multiple Options", "Clean Seating", "Security"] }
                ],
                shopping: [
                    { name: "City Mall", contact: "+91-98765-43220", services: ["Shopping", "Food Court", "Security", "Parking"] },
                    { name: "Local Market", contact: "+91-98765-43221", services: ["Traditional Shopping", "Local Products", "Bargaining"] },
                    { name: "Supermarket", contact: "+91-98765-43222", services: ["Groceries", "Daily Needs", "Safe Shopping"] }
                ],
                education: [
                    { name: "University Campus", contact: "+91-98765-43223", services: ["Education", "Library", "Campus Security"] },
                    { name: "Public Library", contact: "+91-98765-43224", services: ["Books", "Study Space", "Internet"] },
                    { name: "School", contact: "+91-98765-43225", services: ["Education", "Safe Environment", "Community Center"] }
                ],
                worship: [
                    { name: "Temple", contact: "+91-98765-43226", services: ["Worship", "Community Gathering", "Peaceful Environment"] },
                    { name: "Mosque", contact: "+91-98765-43227", services: ["Prayer", "Community Support", "Safe Space"] },
                    { name: "Church", contact: "+91-98765-43228", services: ["Worship", "Community Help", "Sanctuary"] },
                    { name: "Gurudwara", contact: "+91-98765-43229", services: ["Prayer", "Free Food", "Community Service"] }
                ],
                recreation: [
                    { name: "City Park", contact: "+91-98765-43230", services: ["Recreation", "Walking Tracks", "Security Patrol"] },
                    { name: "Sports Complex", contact: "+91-98765-43231", services: ["Sports Facilities", "Fitness Center", "Safe Environment"] },
                    { name: "Cinema Hall", contact: "+91-98765-43232", services: ["Entertainment", "Security", "Family Friendly"] }
                ],
                government: [
                    { name: "District Collector Office", contact: "+91-98765-43233", services: ["Government Services", "Documentation", "Public Grievance"] },
                    { name: "Post Office", contact: "1924", services: ["Postal Services", "Banking", "Government Schemes"] },
                    { name: "Municipal Office", contact: "+91-98765-43234", services: ["Civic Services", "Complaints", "Public Facilities"] }
                ]
            };
            
            const allSpots = [];
            const selectedType = document.getElementById('typeFilter').value;
            const selectedDistance = parseFloat(document.getElementById('distanceFilter').value);
            
            Object.keys(categories).forEach(category => {
                if (!selectedType || selectedType === category) {
                    categories[category].forEach((spot, index) => {
                        const distance = Math.random() * selectedDistance;
                        const angle = Math.random() * 2 * Math.PI;
                        const latOffset = (distance / 111) * Math.cos(angle);
                        const lngOffset = (distance / (111 * Math.cos(userLocation.lat * Math.PI / 180))) * Math.sin(angle);
                        
                        allSpots.push({
                            id: `${category}_${index}`,
                            name: spot.name,
                            type: category,
                            lat: userLocation.lat + latOffset,
                            lon: userLocation.lng + lngOffset,
                            contact: spot.contact,
                            services: spot.services,
                            distance: distance.toFixed(1),
                            available_24x7: Math.random() > 0.6,
                            wheelchair_accessible: Math.random() > 0.4,
                            parking_available: Math.random() > 0.3,
                            female_friendly: Math.random() > 0.2,
                            rating: (3.5 + Math.random() * 1.5).toFixed(1),
                            reviews: Math.floor(Math.random() * 500) + 10
                        });
                    });
                }
            });
            
            return allSpots.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
        }

        function displaySafeSpots(spots) {
            markerCluster.clearLayers();
            currentMarkers = [];

            spots.forEach(spot => {
                const iconHtml = getSpotIcon(spot.type);
                const markerColor = getSpotColor(spot.type);

                const marker = L.marker([spot.lat, spot.lon], {
                    icon: L.divIcon({
                        className: 'safe-spot-marker',
                        html: `<div style="background: ${markerColor}; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">${iconHtml}</div>`,
                        iconSize: [34, 34],
                        iconAnchor: [17, 17]
                    })
                }).bindPopup(createSpotPopup(spot));

                markerCluster.addLayer(marker);
                currentMarkers.push(marker);
            });

            if (spots.length > 0) {
                const group = new L.featureGroup(currentMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function getSpotIcon(type) {
            const icons = {
                'emergency': 'üö®',
                'medical': 'üè•',
                'transport': 'üöá',
                'accommodation': 'üè®',
                'food': 'üçΩÔ∏è',
                'shopping': 'üõçÔ∏è',
                'education': 'üéì',
                'worship': 'üïå',
                'recreation': 'üé™',
                'government': 'üèõÔ∏è'
            };
            return icons[type] || 'üìç';
        }

        function getSpotColor(type) {
            const colors = {
                'emergency': '#ff6b6b',
                'medical': '#51cf66',
                'transport': '#4dabf7',
                'accommodation': '#cc5de8',
                'food': '#fcc419',
                'shopping': '#ff922b',
                'education': '#339af0',
                'worship': '#9775fa',
                'recreation': '#20c997',
                'government': '#495057'
            };
            return colors[type] || '#667eea';
        }

        function createSpotPopup(spot, isNearest = false) {
            const title = isNearest ? `üéØ ${spot.name}` : spot.name;
            const typeIcon = getSpotIcon(spot.type);
            const typeColor = getSpotColor(spot.type);
            
            const distanceInfo = spot.distance ? `<p><i class="fas fa-map-marker-alt"></i> <strong>${spot.distance} km away</strong></p>` : '';
            const contactInfo = spot.contact ? `<p><i class="fas fa-phone"></i> <strong>Contact:</strong> <a href="tel:${spot.contact}" style="color: ${typeColor};">${spot.contact}</a></p>` : '';
            
            const features = [];
            if (spot.available_24x7) features.push('üïí 24/7 Open');
            if (spot.wheelchair_accessible) features.push('‚ôø Wheelchair Access');
            if (spot.parking_available) features.push('üÖøÔ∏è Parking');
            if (spot.female_friendly) features.push('üë© Women Safe');
            
            const featuresHtml = features.length > 0 ? `
                <div style="margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">Features:</div>
                    <div style="font-size: 0.8rem;">${features.join(' ‚Ä¢ ')}</div>
                </div>
            ` : '';
            
            const servicesHtml = spot.services ? `
                <div style="margin: 8px 0;">
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">Services:</div>
                    <div style="font-size: 0.8rem; color: #495057;">${spot.services.join(' ‚Ä¢ ')}</div>
                </div>
            ` : '';
            
            const ratingHtml = spot.rating ? `
                <div style="margin: 8px 0; display: flex; align-items: center; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span style="color: #ffd43b;">‚òÖ</span>
                        <span style="font-weight: 600;">${spot.rating}</span>
                    </div>
                    <span style="font-size: 0.8rem; color: #666;">(${spot.reviews} reviews)</span>
                </div>
            ` : '';
            
            const directionsButton = userLocation ? `
                <div style="margin-top: 12px; display: flex; gap: 8px;">
                    <button onclick="window.getDirectionsToSpot(${spot.lat}, ${spot.lon}, '${spot.name}')" 
                            style="background: ${typeColor}; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; flex: 1; font-size: 0.85rem;">
                        <i class="fas fa-directions"></i> Directions
                    </button>
                    <button onclick="window.callSpot('${spot.contact}')" 
                            style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; flex: 1; font-size: 0.85rem;">
                        <i class="fas fa-phone"></i> Call
                    </button>
                </div>
            ` : '';

            return `
                <div style="min-width: 280px; max-width: 320px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 1.2rem;">${typeIcon}</span>
                        <h4 style="margin: 0; color: ${typeColor};">${title}</h4>
                    </div>
                    <div style="font-size: 0.85rem; color: #666; text-transform: capitalize; margin-bottom: 8px;">${spot.type.replace('_', ' ')}</div>
                    ${distanceInfo}
                    ${contactInfo}
                    ${ratingHtml}
                    ${featuresHtml}
                    ${servicesHtml}
                    ${directionsButton}
                </div>
            `;
        }

        async function loadRealEmergencyServices() {
            if (!userLocation) {
                showToast('üìç Please enable location services');
                return;
            }

            try {
                showToast('üö® Loading emergency services...');
                
                // Mock API call
                const services = await new Promise(resolve => {
                    setTimeout(() => {
                        resolve([
                            {
                                id: 1,
                                type: 'police',
                                name: 'Local Police Station',
                                lat: userLocation.lat + (Math.random() * 0.02 - 0.01),
                                lng: userLocation.lng + (Math.random() * 0.02 - 0.01),
                                distance: (Math.random() * 2 + 0.5).toFixed(1) + ' km',
                                contact: '100',
                                available_24x7: true
                            },
                            {
                                id: 2,
                                type: 'hospital',
                                name: 'General Hospital',
                                lat: userLocation.lat + (Math.random() * 0.02 - 0.01),
                                lng: userLocation.lng + (Math.random() * 0.02 - 0.01),
                                distance: (Math.random() * 3 + 0.8).toFixed(1) + ' km',
                                contact: '108',
                                available_24x7: true
                            }
                        ]);
                    }, 1000);
                });
                
                displayEmergencyServices(services);
                showToast(`‚úÖ Found ${services.length} emergency services nearby`);
                
            } catch (error) {
                console.error('Failed to load emergency services:', error);
                showToast('‚ö†Ô∏è Using local emergency contacts');
                showEmergencyContacts();
            }
        }

        function displayEmergencyServices(services) {
            emergencyLayer.clearLayers();
            
            services.forEach(service => {
                const icon = L.divIcon({
                    className: 'emergency-marker',
                    html: `
                        <div style="
                            background: ${getServiceColor(service.type)};
                            color: white;
                            width: 32px;
                            height: 32px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 14px;
                            border: 3px solid white;
                            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
                            animation: pulse 3s infinite;
                        ">
                            ${getServiceIcon(service.type)}
                        </div>
                    `,
                    iconSize: [38, 38],
                    iconAnchor: [19, 19]
                });

                const marker = L.marker([service.lat, service.lng], { icon: icon })
                    .addTo(emergencyLayer)
                    .bindPopup(`
                        <div style="min-width: 200px;">
                            <h4>${service.name}</h4>
                            <p><strong>Type:</strong> ${service.type.toUpperCase()}</p>
                            <p><strong>Distance:</strong> ${service.distance}</p>
                            <p><strong>Contact:</strong> ${service.contact}</p>
                            ${service.available_24x7 ? '<p>üïí <strong>24/7 Available</strong></p>' : ''}
                            <div style="margin-top: 10px;">
                                <button onclick="callEmergency('${service.contact}')" 
                                        style="background: #ff6b6b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; width: 100%;">
                                    <i class="fas fa-phone"></i> Call ${service.contact}
                                </button>
                            </div>
                        </div>
                    `);
            });
        }

        function getServiceColor(type) {
            const colors = {
                'police': '#ff6b6b',
                'hospital': '#51cf66',
                'fire': '#ff922b',
                'support': '#4dabf7'
            };
            return colors[type] || '#667eea';
        }

        function getServiceIcon(type) {
            const icons = {
                'police': 'üöî',
                'hospital': 'üè•',
                'fire': 'üöí',
                'support': 'üÜò'
            };
            return icons[type] || 'üìç';
        }

        function callEmergency(number) {
            if (confirm(`üö® Call emergency service: ${number}?`)) {
                showToast(`üìû Calling ${number}... (Simulated)`);
                setTimeout(() => {
                    showToast('‚úÖ Emergency call initiated. Help is on the way!');
                }, 2000);
            }
        }

        // Enhanced SOS function
        async function sendEnhancedSOS() {
            if (!userLocation) {
                showToast('üìç Getting your location for SOS...');
                await getUserLocation();
            }

            const confirmSOS = confirm(`üö® EMERGENCY ALERT\n\nThis will:\n‚Ä¢ Notify emergency services\n‚Ä¢ Share your live location\n‚Ä¢ Alert your emergency contacts\n‚Ä¢ Activate continuous tracking\n\nAre you in immediate danger?`);
            
            if (!confirmSOS) return;

            try {
                userProfile.status = 'emergency';
                updateStatusUI('emergency');

                await sendToEmergencyServices(userLocation);
                startEnhancedLocationSharing();
                emergencyVisualAlert();
                
                showToast('üö® SOS ACTIVATED! Emergency services notified.');

            } catch (error) {
                console.error('SOS error:', error);
                showToast('‚ö†Ô∏è Emergency alert triggered locally!');
                startEnhancedLocationSharing();
            }
        }

        async function sendToEmergencyServices(location) {
            showToast('üì° Notifying emergency services...');
            await new Promise(resolve => setTimeout(resolve, 2000));
            console.log('Emergency services notified:', location);
            return { success: true, message: 'Emergency services alerted' };
        }

        function startEnhancedLocationSharing() {
            if (liveLocationInterval) {
                clearInterval(liveLocationInterval);
            }

            isSharingLocation = true;
            userProfile.liveSharing.isActive = true;

            const shareButton = document.getElementById('shareLiveLocation');
            const sharingStatus = document.getElementById('sharingStatus');
            if (shareButton) {
                shareButton.innerHTML = '<i class="fas fa-stop"></i> Stop Sharing';
                shareButton.classList.remove('btn-outline');
                shareButton.classList.add('btn-danger');
            }

            liveLocationInterval = setInterval(async () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy,
                                timestamp: new Date().toISOString()
                            };
                            
                            updateUserMarker();
                            
                            const secureLocation = applyLocationPrivacy(
                                userLocation, 
                                privacySettings.location_sharing.precision
                            );
                            
                            console.log('Secure location sharing:', secureLocation);
                            
                        },
                        (error) => {
                            console.warn('Location sharing error:', error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 5000,
                            maximumAge: 0
                        }
                    );
                }
            }, 30000);

            console.log('üìç Enhanced location sharing activated');
            showToast('üìç Enhanced location sharing activated');
        }

        function applyLocationPrivacy(location, precision) {
            const preciseLocation = { ...location };
            
            switch (precision) {
                case 'approximate':
                    return {
                        ...location,
                        lat: Math.round(location.lat * 1000) / 1000,
                        lng: Math.round(location.lng * 1000) / 1000,
                        accuracy: Math.max(location.accuracy || 0, 100)
                    };
                case 'city':
                    return {
                        ...location,
                        lat: Math.round(location.lat * 100) / 100,
                        lng: Math.round(location.lng * 100) / 100,
                        accuracy: Math.max(location.accuracy || 0, 1000)
                    };
                default:
                    return preciseLocation;
            }
        }

        function getRouteColor(safetyPref) {
            const colors = {
                'safest': '#51cf66',
                'balanced': '#ffd43b',
                'accessible': '#4dabf7',
                'fastest': '#ff6b6b'
            };
            return colors[safetyPref] || '#667eea';
        }

        function getIssueTypeDisplay(type) {
            const types = {
                'broken_road': 'üöß Broken Road/Footpath',
                'no_streetlight': 'üí° No Street Light',
                'poor_visibility': 'üëÅÔ∏è Poor Visibility Area',
                'harassment_zone': '‚ö†Ô∏è Harassment Prone Area',
                'unsafe_crowd': 'üë• Unsafe Crowd',
                'transport_issue': 'üöç Public Transport Issue',
                'accessibility': '‚ôø Accessibility Barrier',
                'other': '‚ùì Other Safety Concern'
            };
            return types[type] || type;
        }

        function getAccessibilityDisplay(impact) {
            const impacts = {
                'wheelchair': '‚ôø',
                'visual_impairment': 'üëÅÔ∏è',
                'hearing_impairment': 'üëÇ',
                'mobility_issues': 'üö∂'
            };
            return impacts[impact] || impact;
        }

        function calculateDistanceBetweenPoints(point1, point2) {
            const R = 6371e3;
            const œÜ1 = point1.lat * Math.PI / 180;
            const œÜ2 = point2.lat * Math.PI / 180;
            const ŒîœÜ = (point2.lat - point1.lat) * Math.PI / 180;
            const ŒîŒª = (point2.lng - point1.lng) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        function getHazardsNearPoint(lat, lng, radius) {
            return hazardReports.filter(hazard => {
                const distance = calculateDistanceBetweenPoints(
                    { lat, lng }, 
                    { lat: hazard.lat, lng: hazard.lng }
                );
                return distance < radius;
            });
        }

        // ========================
        // üì± MOBILE APP FEATURES
        // ========================

        // Battery optimization
        function optimizeForBattery() {
            if (navigator.getBattery) {
                navigator.getBattery().then(battery => {
                    updateBatteryOptimization(battery.level);
                    
                    battery.addEventListener('levelchange', () => {
                        updateBatteryOptimization(battery.level);
                    });
                });
            }
        }

        function updateBatteryOptimization(batteryLevel) {
            if (batteryLevel < 0.2) {
                if (liveLocationInterval) {
                    clearInterval(liveLocationInterval);
                    liveLocationInterval = setInterval(updateLocation, 120000);
                }
                disableNonEssentialFeatures();
                showToast('üîã Low battery: Optimizing for power saving');
            } else if (batteryLevel < 0.5) {
                if (liveLocationInterval) {
                    clearInterval(liveLocationInterval);
                    liveLocationInterval = setInterval(updateLocation, 60000);
                }
            }
        }

        function disableNonEssentialFeatures() {
            document.body.classList.add('battery-saver');
        }

        // Offline functionality
        function setupOfflineSupport() {
            window.addEventListener('online', () => {
                showToast('üåê Back online - Syncing data...');
                syncOfflineData();
            });
            
            window.addEventListener('offline', () => {
                showToast('üì∂ Offline mode - Basic features available');
            });
        }

        function syncOfflineData() {
            const offlineReports = JSON.parse(localStorage.getItem('safescape_offline_reports') || '[]');
            
            if (offlineReports.length > 0) {
                showToast(`üì§ Syncing ${offlineReports.length} offline reports...`);
                
                offlineReports.forEach(async (report) => {
                    try {
                        // Simulate API call
                        await new Promise(resolve => setTimeout(resolve, 500));
                        hazardReports.push(report);
                        displayCommunityHazard(report);
                    } catch (error) {
                        console.error('Failed to sync report:', error);
                    }
                });
                
                localStorage.removeItem('safescape_offline_reports');
            }
        }

        // Touch-optimized controls
        function setupTouchControls() {
            if ('ontouchstart' in window) {
                document.body.classList.add('touch-device');
                
                const buttons = document.querySelectorAll('.btn, .fab, .quick-btn');
                buttons.forEach(btn => {
                    btn.style.minHeight = '44px';
                    btn.style.minWidth = '44px';
                });
            }
        }

        // Data cleanup for privacy
        function cleanupOldData() {
            const now = new Date();
            
            // Cleanup old location history
            const locationHistory = JSON.parse(localStorage.getItem('safescape_location_history') || '[]');
            const cleanLocationHistory = locationHistory.filter(entry => {
                const entryDate = new Date(entry.timestamp);
                const daysAgo = (now - entryDate) / (1000 * 60 * 60 * 24);
                return daysAgo <= 30;
            });
            localStorage.setItem('safescape_location_history', JSON.stringify(cleanLocationHistory));
            
            console.log('Privacy cleanup completed');
        }

        // ========================
        // üéØ EVENT LISTENERS
        // ========================
        function initEventListeners() {
            // Location & Route
            document.getElementById('locationBtn').addEventListener('click', () => {
                if (userLocation) {
                    map.setView([userLocation.lat, userLocation.lng], 15);
                    showToast('üìç Centered on your location');
                } else {
                    getUserLocation();
                }
            });

            document.getElementById('planRouteBtn').addEventListener('click', planRealRoute);
            document.getElementById('closeRoute').addEventListener('click', () => {
                document.getElementById('routeInstructions').style.display = 'none';
                if (routeControl) {
                    if (routeControl.line) map.removeLayer(routeControl.line);
                    if (routeControl.startMarker) map.removeLayer(routeControl.startMarker);
                    if (routeControl.endMarker) map.removeLayer(routeControl.endMarker);
                    routeControl = null;
                }
                showToast('üó∫Ô∏è Route cleared');
            });

            // Map Controls
            document.getElementById('zoomInBtn').addEventListener('click', () => {
                map.zoomIn();
            });

            document.getElementById('zoomOutBtn').addEventListener('click', () => {
                map.zoomOut();
            });

            document.getElementById('resetViewBtn').addEventListener('click', () => {
                if (userLocation) {
                    map.setView([userLocation.lat, userLocation.lng], 13);
                } else {
                    map.setView([20.5937, 78.9629], 5);
                }
                showToast('üó∫Ô∏è Map view reset');
            });

            // Safety & Emergency
            document.getElementById('sosBtn').addEventListener('click', sendEnhancedSOS);
            document.getElementById('quickSOS').addEventListener('click', sendEnhancedSOS);
            document.getElementById('nearbyBtn').addEventListener('click', findNearbySpots);
            document.getElementById('nearestBtn').addEventListener('click', findNearestSpot);
            
            // Safe Spots Filters
            document.getElementById('filterBtn').addEventListener('click', showAdvancedFilters);
            document.getElementById('saveSearchBtn').addEventListener('click', saveCurrentSearch);
            
            // Auto-search on filter change
            ['citySelect', 'typeFilter', 'distanceFilter'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    if (userLocation) findNearbySpots();
                });
            });
            
            // Auto-search on accessibility filter change
            ['wheelchair_access', 'parking_available', '24x7_available', 'female_friendly'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    if (userLocation) findNearbySpots();
                });
            });

            // Status buttons
            document.getElementById('statusSafe').addEventListener('click', () => {
                userProfile.status = 'safe';
                updateStatusUI('safe');
                saveUserProfile();
                showToast('‚úÖ Status set to Safe');
            });

            document.getElementById('statusConcern').addEventListener('click', () => {
                userProfile.status = 'concern';
                updateStatusUI('concern');
                saveUserProfile();
                showToast('‚ö†Ô∏è Status set to Concerned');
            });

            // Profile & Settings
            document.getElementById('profileBtn').addEventListener('click', () => {
                if (userProfile.emergencyContacts.length > 0 || userProfile.safetyPreferences.length > 0) {
                    showProfileReadOnlyView();
                } else {
                    showProfileEditView();
                }
                document.getElementById('profileModal').classList.add('active');
            });

            // Quick Actions
            document.getElementById('contactsBtn').addEventListener('click', showEmergencyContacts);
            document.getElementById('safetyTipsBtn').addEventListener('click', showSafetyTips);
            document.getElementById('accessibilityBtn').addEventListener('click', showAccessibilityInfo);
            document.getElementById('panicModeBtn').addEventListener('click', activatePanicMode);
            document.getElementById('safeRouteBtn').addEventListener('click', findSafestRoute);
            document.getElementById('nearbyHelpBtn').addEventListener('click', findNearbyHelp);
            document.getElementById('checkInBtn').addEventListener('click', performSafetyCheckIn);
            
            // Emergency Quick Actions - Ensure proper binding
            function bindEmergencyButtons() {
                const emergencyButtons = [
                    { id: 'callPoliceBtn', number: '100', service: 'Police' },
                    { id: 'callAmbulanceBtn', number: '108', service: 'Ambulance' },
                    { id: 'callFireBtn', number: '101', service: 'Fire Department' },
                    { id: 'womenHelplineBtn', number: '1091', service: 'Women Helpline' }
                ];
                
                emergencyButtons.forEach(btn => {
                    const element = document.getElementById(btn.id);
                    if (element) {
                        // Remove existing listeners
                        element.replaceWith(element.cloneNode(true));
                        const newElement = document.getElementById(btn.id);
                        
                        newElement.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            window.callEmergencyService(btn.number, btn.service);
                        });
                        
                        console.log(`‚úÖ Emergency button bound: ${btn.service}`);
                    }
                });
            }
            
            // Bind immediately and retry if needed
            bindEmergencyButtons();
            setTimeout(bindEmergencyButtons, 500);
            setTimeout(bindEmergencyButtons, 1000);

            // Location Sharing
            document.getElementById('shareLiveLocation').addEventListener('click', toggleLocationSharing);

            // Theme Toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Mobile Menu
            document.getElementById('mobileMenuToggle').addEventListener('click', toggleMobileMenu);
            document.getElementById('mobileReportsBtn').addEventListener('click', () => {
                document.getElementById('reportsModal').classList.add('active');
                displayReports();
                closeMobileMenu();
            });
            document.getElementById('mobileProfileBtn').addEventListener('click', () => {
                if (userProfile.emergencyContacts.length > 0 || userProfile.safetyPreferences.length > 0) {
                    showProfileReadOnlyView();
                } else {
                    showProfileEditView();
                }
                document.getElementById('profileModal').classList.add('active');
                closeMobileMenu();
            });
            document.getElementById('mobileThemeToggle').addEventListener('click', () => {
                toggleTheme();
                closeMobileMenu();
            });

            // Profile form submission
            document.getElementById('saveProfileBtn').addEventListener('click', saveProfileSettings);

            // Reports
            document.getElementById('reportsBtn').addEventListener('click', () => {
                document.getElementById('reportsModal').classList.add('active');
                displayReports();
            });

            document.getElementById('closeReportsModal').addEventListener('click', () => {
                document.getElementById('reportsModal').classList.remove('active');
            });

            document.getElementById('closeReportsBtn').addEventListener('click', () => {
                document.getElementById('reportsModal').classList.remove('active');
            });
            
            document.getElementById('refreshReports').addEventListener('click', () => {
                displayReports();
                showToast('üîÑ Reports refreshed');
            });
            
            document.getElementById('filterVerified').addEventListener('click', (e) => {
                e.target.classList.toggle('btn-primary');
                e.target.classList.toggle('btn-outline');
                filterReports();
            });
            
            document.getElementById('searchReports').addEventListener('input', filterReports);

            // Trip Planning
            document.getElementById('closeTripModal').addEventListener('click', () => {
                document.getElementById('tripModal').classList.remove('active');
            });

            document.getElementById('closeTripBtn').addEventListener('click', () => {
                document.getElementById('tripModal').classList.remove('active');
            });

            // Heatmap Toggle
            document.getElementById('heatmapToggle').addEventListener('change', toggleSafetyHeatmap);

            // Global event for escape key to close modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeAllModals();
                }
            });

            // Close mobile menu when clicking outside
            document.addEventListener('click', (e) => {
                const mobileMenu = document.getElementById('mobileMenu');
                const mobileMenuToggle = document.getElementById('mobileMenuToggle');
                
                if (mobileMenu.classList.contains('active') && 
                    !mobileMenu.contains(e.target) && 
                    !mobileMenuToggle.contains(e.target)) {
                    closeMobileMenu();
                }
            });
        }

        // ========================
        // üé® UI HELPER FUNCTIONS
        // ========================
        function showToast(message) {
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%) translateY(100px);
                    background: var(--dark);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 8px;
                    box-shadow: var(--shadow);
                    z-index: 3000;
                    transition: transform 0.3s ease;
                    font-weight: 500;
                    max-width: 80%;
                    text-align: center;
                    pointer-events: none;
                `;
                document.body.appendChild(toast);
            }

            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const icon = document.querySelector('#themeToggle i');
            const mobileIcon = document.querySelector('#mobileThemeToggle i');
            const themeToggle = document.getElementById('themeToggle');
            const mobileThemeToggle = document.getElementById('mobileThemeToggle');
            
            if (document.body.classList.contains('dark-mode')) {
                icon.className = 'fas fa-sun';
                mobileIcon.className = 'fas fa-sun';
                themeToggle.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
                mobileThemeToggle.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
                showToast('üåô Dark mode activated');
            } else {
                icon.className = 'fas fa-moon';
                mobileIcon.className = 'fas fa-moon';
                themeToggle.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
                mobileThemeToggle.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
                showToast('‚òÄÔ∏è Light mode activated');
            }
            
            saveUserProfile();
        }

        function toggleLocationSharing() {
            const contact = document.getElementById('emergencyContact').value.trim();
            if (!contact && !isSharingLocation) {
                showToast('‚ùå Please enter emergency contact details');
                return;
            }

            if (!isSharingLocation) {
                userProfile.liveSharing.contact = contact;
                userProfile.liveSharing.isActive = true;
                startEnhancedLocationSharing();
            } else {
                stopLiveLocationSharing();
            }
            
            saveUserProfile();
        }

        function stopLiveLocationSharing() {
            if (liveLocationInterval) {
                clearInterval(liveLocationInterval);
                liveLocationInterval = null;
            }
            
            isSharingLocation = false;
            userProfile.liveSharing.isActive = false;

            const shareButton = document.getElementById('shareLiveLocation');
            if (shareButton) {
                shareButton.innerHTML = '<i class="fas fa-share-alt"></i> Start Sharing';
                shareButton.classList.remove('btn-danger');
                shareButton.classList.add('btn-outline');
            }

            console.log('üìç Live location sharing stopped');
            showToast('üìç Location sharing stopped');
        }

        function updateStatusUI(status) {
            const statusDisplay = document.getElementById('userStatusDisplay');
            const safeBtn = document.getElementById('statusSafe');
            const concernBtn = document.getElementById('statusConcern');
            
            // Update status display
            if (statusDisplay) {
                statusDisplay.className = `user-status status-${status}`;
                
                if (status === 'safe') {
                    statusDisplay.innerHTML = '<i class="fas fa-check-circle"></i><span>You are currently safe</span>';
                } else if (status === 'concern') {
                    statusDisplay.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>You have safety concerns</span>';
                } else if (status === 'emergency') {
                    statusDisplay.innerHTML = '<i class="fas fa-bell"></i><span>EMERGENCY - Help is on the way</span>';
                }
            }
            
            // Update buttons
            if (status === 'safe') {
                safeBtn.classList.add('btn-success');
                safeBtn.classList.remove('btn-outline');
                concernBtn.classList.add('btn-outline');
                concernBtn.classList.remove('btn-warning');
            } else if (status === 'concern') {
                safeBtn.classList.add('btn-outline');
                safeBtn.classList.remove('btn-success');
                concernBtn.classList.add('btn-warning');
                concernBtn.classList.remove('btn-outline');
            } else if (status === 'emergency') {
                safeBtn.classList.add('btn-danger');
                safeBtn.classList.remove('btn-success', 'btn-outline');
                concernBtn.classList.add('btn-danger');
                concernBtn.classList.remove('btn-warning', 'btn-outline');
            }
        }

        function emergencyVisualAlert() {
            const originalZoom = map.getZoom();
            map.setZoom(originalZoom + 1);
            setTimeout(() => map.setZoom(originalZoom), 500);
            setTimeout(() => map.setZoom(originalZoom + 1), 1000);
            setTimeout(() => map.setZoom(originalZoom), 1500);
            
            const sosBtn = document.getElementById('sosBtn');
            sosBtn.classList.add('shake');
            setTimeout(() => sosBtn.classList.remove('shake'), 1000);
        }

        function showEmergencyContacts() {
            const city = document.getElementById('citySelect').value || 'delhi';
            const contacts = {
                'delhi': { police: '100', ambulance: '108', women_helpline: '1091', fire: '101' },
                'mumbai': { police: '100', ambulance: '108', women_helpline: '103', fire: '101' },
                'bangalore': { police: '100', ambulance: '108', women_helpline: '1091', fire: '101' },
                'jaipur': { police: '100', ambulance: '108', women_helpline: '1090', fire: '101' },
                'lucknow': { police: '100', ambulance: '108', women_helpline: '1090', fire: '101' },
                'gurugram': { police: '100', ambulance: '108', women_helpline: '1091', fire: '101' }
            };

            const cityContacts = contacts[city] || contacts.delhi;
            
            alert(`üÜò EMERGENCY CONTACTS - ${city.toUpperCase()}\n\n` +
                  `üöî Police: ${cityContacts.police}\n` +
                  `üöë Ambulance: ${cityContacts.ambulance}\n` +
                  `üë©‚Äç‚öïÔ∏è Women Helpline: ${cityContacts.women_helpline}\n` +
                  `üî• Fire: ${cityContacts.fire}\n` +
                  `üéØ Disaster Management: 108\n\n` +
                  `Save these numbers in your phone!\n` +
                  `Share your location immediately in emergencies.`);
        }

        function showSafetyTips() {
            alert(`üö® SAFETY TIPS FOR TRAVELERS\n\n` +
                  `üîπ Always share your live location with trusted contacts\n` +
                  `üîπ Plan your route using SafeScape's safety-focused routing\n` +
                  `üîπ Avoid poorly lit or isolated areas, especially at night\n` +
                  `üîπ Keep emergency numbers easily accessible\n` +
                  `üîπ Trust your instincts - if something feels wrong, leave immediately\n` +
                  `üîπ Use well-traveled routes and stay in public view\n` +
                  `üîπ Keep your phone charged and carry a power bank\n` +
                  `üîπ Learn basic self-defense techniques\n` +
                  `üîπ Be aware of your surroundings at all times\n` +
                  `üîπ Use SafeScape's SOS feature in emergencies\n\n` +
                  `Your safety is our priority!`);
        }

        function showAccessibilityInfo() {
            alert(`‚ôø ACCESSIBILITY FEATURES\n\n` +
                  `üîπ Route planning considers wheelchair accessibility\n` +
                  `üîπ Reports include accessibility impact assessments\n` +
                  `üîπ Safe spots marked with accessibility information\n` +
                  `üîπ Voice guidance support for visually impaired\n` +
                  `üîπ Customizable preferences for different mobility needs\n` +
                  `üîπ Accessibility-focused routing options\n` +
                  `üîπ Barrier reporting system\n\n` +
                  `Enable accessibility features in your profile settings for personalized experience.`);
        }

        function saveProfileSettings() {
            userProfile.travelerType = document.getElementById('travelerType').value;

            userProfile.safetyPreferences = [];
            const safetyPrefs = ['pref_well_lit', 'pref_populated', 'pref_main_roads', 'auto_share_location'];
            safetyPrefs.forEach(id => {
                if (document.getElementById(id).checked) {
                    userProfile.safetyPreferences.push(id);
                }
            });

            userProfile.accessibilityNeeds = [];
            const accessibility = ['need_wheelchair', 'need_elevator', 'need_ramps', 'avoid_stairs'];
            accessibility.forEach(id => {
                if (document.getElementById(id).checked) {
                    userProfile.accessibilityNeeds.push(id);
                }
            });

            userProfile.emergencyContacts = [];
            const contact1Name = document.getElementById('contact1Name').value.trim();
            const contact1Info = document.getElementById('contact1Info').value.trim();
            const contact2Name = document.getElementById('contact2Name').value.trim();
            const contact2Info = document.getElementById('contact2Info').value.trim();

            if (contact1Name && contact1Info) {
                userProfile.emergencyContacts.push({ name: contact1Name, info: contact1Info });
            }
            if (contact2Name && contact2Info) {
                userProfile.emergencyContacts.push({ name: contact2Name, info: contact2Info });
            }

            saveUserProfile();
            showSaveIndicator();
            showProfileReadOnlyView();
        }
        
        function showProfileReadOnlyView() {
            const modal = document.getElementById('profileModal');
            const content = modal.querySelector('.modal-content');
            
            const travelerTypes = {
                'solo_female': 'üë© Solo Female Traveler',
                'solo_male': 'üë® Solo Male Traveler', 
                'family': 'üë®üë©üëßüë¶ Family with Children',
                'senior': 'üßì Senior Citizen',
                'disabled': '‚ôø Person with Disability',
                'student': 'üéì Student',
                'tourist': 'üß≥ Tourist'
            };
            
            const safetyPrefLabels = {
                'pref_well_lit': 'üí° Prefer well-lit routes',
                'pref_populated': 'üë• Prefer populated areas',
                'pref_main_roads': 'üõ£Ô∏è Prefer main roads',
                'auto_share_location': 'üìç Auto-share location in emergency'
            };
            
            const accessibilityLabels = {
                'need_wheelchair': '‚ôø Wheelchair access',
                'need_elevator': 'üìà Elevators required',
                'need_ramps': 'üõ£Ô∏è Ramps needed',
                'avoid_stairs': 'üö´ Avoid stairs'
            };
            
            content.innerHTML = `
                <button class="modal-close" onclick="document.getElementById('profileModal').classList.remove('active')">&times;</button>
                <h2 class="modal-title">
                    <i class="fas fa-user-check"></i>
                    Your Profile
                </h2>
                
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin: 0 0 1rem 0; color: var(--primary);">Traveler Type</h3>
                    <p style="margin: 0; font-size: 1.1rem;">${travelerTypes[userProfile.travelerType]}</p>
                </div>
                
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin: 0 0 1rem 0; color: var(--primary);">Emergency Contacts</h3>
                    ${userProfile.emergencyContacts.length > 0 ? 
                        userProfile.emergencyContacts.map((contact, i) => 
                            `<p style="margin: 0.5rem 0;"><strong>${contact.name}:</strong> ${contact.info}</p>`
                        ).join('') : 
                        '<p style="margin: 0; opacity: 0.7;">No emergency contacts added</p>'
                    }
                </div>
                
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin: 0 0 1rem 0; color: var(--primary);">Safety Preferences</h3>
                    ${userProfile.safetyPreferences.length > 0 ? 
                        userProfile.safetyPreferences.map(pref => 
                            `<p style="margin: 0.5rem 0;">${safetyPrefLabels[pref]}</p>`
                        ).join('') : 
                        '<p style="margin: 0; opacity: 0.7;">No preferences set</p>'
                    }
                </div>
                
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin: 0 0 1rem 0; color: var(--primary);">Accessibility Needs</h3>
                    ${userProfile.accessibilityNeeds.length > 0 ? 
                        userProfile.accessibilityNeeds.map(need => 
                            `<p style="margin: 0.5rem 0;">${accessibilityLabels[need]}</p>`
                        ).join('') : 
                        '<p style="margin: 0; opacity: 0.7;">No accessibility needs specified</p>'
                    }
                </div>
                
                <button class="btn btn-primary" onclick="showProfileEditView()" style="width: 100%;">
                    <i class="fas fa-edit"></i> Edit Profile
                </button>
            `;
        }
        
        function showProfileEditView() {
            const modal = document.getElementById('profileModal');
            const content = modal.querySelector('.modal-content');
            
            content.innerHTML = `
                <button class="modal-close" onclick="document.getElementById('profileModal').classList.remove('active')">&times;</button>
                <h2 class="modal-title">
                    <i class="fas fa-user-cog"></i>
                    Edit Profile & Settings
                </h2>

                <div class="form-group">
                    <label class="form-label">Traveler Type</label>
                    <select class="form-select" id="travelerType">
                        <option value="solo_female">üë© Solo Female Traveler</option>
                        <option value="solo_male">üë® Solo Male Traveler</option>
                        <option value="family">üë®üë©üëßüë¶ Family with Children</option>
                        <option value="senior">üßì Senior Citizen</option>
                        <option value="disabled">‚ôø Person with Disability</option>
                        <option value="student">üéì Student</option>
                        <option value="tourist">üß≥ Tourist</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Emergency Contacts</label>
                    <input type="text" class="form-input" placeholder="Contact 1 - Name" id="contact1Name">
                    <input type="text" class="form-input" placeholder="Phone/Email" id="contact1Info" style="margin-top: 0.5rem;">
                    <input type="text" class="form-input" placeholder="Contact 2 - Name" id="contact2Name" style="margin-top: 0.5rem;">
                    <input type="text" class="form-input" placeholder="Phone/Email" id="contact2Info" style="margin-top: 0.5rem;">
                </div>

                <div class="form-group">
                    <label class="form-label">Accessibility Needs</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="need_wheelchair"> ‚ôø Wheelchair access
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="need_elevator"> üìà Elevators required
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="need_ramps"> üõ£Ô∏è Ramps needed
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="avoid_stairs"> üö´ Avoid stairs
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Safety Preferences</label>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 0.5rem;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="pref_well_lit" checked> üí° Prefer well-lit routes
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="pref_populated" checked> üë• Prefer populated areas
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="pref_main_roads"> üõ£Ô∏è Prefer main roads
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="auto_share_location"> üìç Auto-share location in emergency
                        </label>
                    </div>
                </div>

                <button class="btn btn-primary" id="saveProfileBtn" style="width: 100%; margin-top: 1.5rem;">
                    <i class="fas fa-save"></i> Save Profile
                </button>
            `;
            
            updateProfileUI();
            
            // Add event listener for save button
            document.getElementById('saveProfileBtn').addEventListener('click', saveProfileSettings);
        }
        
        window.showProfileEditView = showProfileEditView;

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.style.display = 'block';
            
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const toggleIcon = document.querySelector('#mobileMenuToggle i');
            
            if (mobileMenu.classList.contains('active')) {
                closeMobileMenu();
            } else {
                mobileMenu.classList.add('active');
                toggleIcon.className = 'fas fa-times';
            }
        }

        function closeMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const toggleIcon = document.querySelector('#mobileMenuToggle i');
            
            mobileMenu.classList.remove('active');
            toggleIcon.className = 'fas fa-bars';
        }

        function closeAllModals() {
            document.querySelectorAll('.modal.active').forEach(modal => {
                modal.classList.remove('active');
            });
            closeMobileMenu();
        }

        // ========================
        // üìã REPORTS MANAGEMENT
        // ========================
        function generateSampleReports() {
            const reportTypes = ['broken_road', 'no_streetlight', 'poor_visibility', 'harassment_zone', 'unsafe_crowd', 'transport_issue', 'accessibility', 'other'];
            const severities = ['low', 'medium', 'high', 'critical'];
            const descriptions = {
                'broken_road': ['Pothole on main street', 'Cracked footpath near bus stop', 'Damaged road surface', 'Broken sidewalk tiles'],
                'no_streetlight': ['Street light not working', 'Dark alley with no lighting', 'Broken lamp post', 'No lights after 10 PM'],
                'poor_visibility': ['Overgrown bushes blocking view', 'Fog area with poor visibility', 'Blind corner', 'Construction blocking view'],
                'harassment_zone': ['Reported incidents in this area', 'Unsafe for solo travelers', 'Frequent harassment reports', 'Avoid after dark'],
                'unsafe_crowd': ['Rowdy crowd gathering', 'Suspicious activity', 'Large unruly group', 'Avoid this area'],
                'transport_issue': ['Bus stop unsafe', 'No proper transport', 'Overcrowded station', 'Poor transport connectivity'],
                'accessibility': ['No wheelchair ramp', 'Stairs only access', 'No elevator', 'Barrier for disabled'],
                'other': ['General safety concern', 'Suspicious activity', 'Poor maintenance', 'Safety hazard']
            };
            
            const cities = ['Delhi', 'Mumbai', 'Bangalore', 'Jaipur', 'Lucknow', 'Gurugram'];
            const areas = ['Market Area', 'Bus Station', 'Park', 'Shopping Mall', 'Residential Area', 'Office Complex', 'Hospital', 'School Zone'];
            
            for (let i = 1; i <= 55; i++) {
                const type = reportTypes[Math.floor(Math.random() * reportTypes.length)];
                const severity = severities[Math.floor(Math.random() * severities.length)];
                const city = cities[Math.floor(Math.random() * cities.length)];
                const area = areas[Math.floor(Math.random() * areas.length)];
                const descArray = descriptions[type];
                const description = descArray[Math.floor(Math.random() * descArray.length)];
                
                const daysAgo = Math.floor(Math.random() * 30);
                const timestamp = new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000).toISOString();
                
                const report = {
                    id: i.toString(),
                    type: type,
                    severity: severity,
                    description: description,
                    location: `${area}, ${city}`,
                    lat: userLocation ? userLocation.lat + (Math.random() - 0.5) * 0.1 : 28.6139 + (Math.random() - 0.5) * 0.1,
                    lng: userLocation ? userLocation.lng + (Math.random() - 0.5) * 0.1 : 77.2090 + (Math.random() - 0.5) * 0.1,
                    timestamp: timestamp,
                    verified: Math.random() > 0.3,
                    verification_count: Math.floor(Math.random() * 10) + 1,
                    reported_by: 'Community User'
                };
                
                allReports.push(report);
            }
        }
        
        function displayReports(reports = allReports) {
            const reportsList = document.getElementById('reportsList');
            
            if (reports.length === 0) {
                reportsList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-inbox"></i>
                        <p>No reports found</p>
                    </div>
                `;
                return;
            }
            
            reportsList.innerHTML = '';
            
            reports.forEach(report => {
                const severityColors = {
                    'critical': '#ff6b6b',
                    'high': '#ffa94d', 
                    'medium': '#ffd43b',
                    'low': '#51cf66'
                };
                
                const reportCard = document.createElement('div');
                reportCard.className = 'report-card';
                reportCard.style.cssText = `
                    background: var(--card-bg);
                    border-radius: 12px;
                    padding: 1rem;
                    margin-bottom: 1rem;
                    border-left: 4px solid ${severityColors[report.severity]};
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    transition: transform 0.2s ease;
                    cursor: pointer;
                `;
                
                reportCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                        <h4 style="margin: 0; color: var(--primary);">${getIssueTypeDisplay(report.type)}</h4>
                        <span style="background: ${severityColors[report.severity]}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                            ${report.severity.toUpperCase()}
                        </span>
                    </div>
                    <p style="margin: 0.5rem 0; color: var(--dark); opacity: 0.8;">${report.description}</p>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: var(--dark); opacity: 0.7;">
                        <span><i class="fas fa-map-marker-alt"></i> ${report.location}</span>
                        <span>${formatTimeAgo(report.timestamp)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                        <span style="font-size: 0.8rem;">
                            ${report.verified ? '<i class="fas fa-check-circle" style="color: #51cf66;"></i> Verified' : '<i class="fas fa-clock" style="color: #ffd43b;"></i> Pending'}
                            (${report.verification_count} confirmations)
                        </span>
                        <button onclick="viewReportOnMap(${report.lat}, ${report.lng}, '${report.id}')" 
                                style="background: var(--primary); color: white; border: none; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; cursor: pointer;">
                            <i class="fas fa-map"></i> View on Map
                        </button>
                    </div>
                `;
                
                reportCard.addEventListener('mouseenter', () => {
                    reportCard.style.transform = 'translateY(-2px)';
                });
                
                reportCard.addEventListener('mouseleave', () => {
                    reportCard.style.transform = 'translateY(0)';
                });
                
                reportsList.appendChild(reportCard);
            });
        }
        
        function filterReports() {
            const searchTerm = document.getElementById('searchReports').value.toLowerCase();
            const showVerifiedOnly = document.getElementById('filterVerified').classList.contains('btn-primary');
            
            let filteredReports = allReports;
            
            if (searchTerm) {
                filteredReports = filteredReports.filter(report => 
                    report.description.toLowerCase().includes(searchTerm) ||
                    report.location.toLowerCase().includes(searchTerm) ||
                    report.type.toLowerCase().includes(searchTerm)
                );
            }
            
            if (showVerifiedOnly) {
                filteredReports = filteredReports.filter(report => report.verified);
            }
            
            displayReports(filteredReports);
        }
        
        window.viewReportOnMap = function(lat, lng, reportId) {
            document.getElementById('reportsModal').classList.remove('active');
            map.setView([lat, lng], 16);
            
            // Find and open the marker popup
            hazardLayer.eachLayer(layer => {
                if (layer.hazardId === reportId) {
                    layer.openPopup();
                }
            });
            
            showToast('üìç Report location shown on map');
        };

        // ========================
        // üöÄ INITIALIZATION
        // ========================
        async function init() {
            console.log('üöÄ Initializing Enhanced SafeScape...');
            
            // Load user profile
            loadUserProfile();
            
            // Get user location
            await getUserLocation();
            
            // Generate sample reports
            generateSampleReports();
            
            // Initialize systems
            initEventListeners();
            setupReporting();
            setupFormValidation();
            setupOfflineSupport();
            setupTouchControls();
            optimizeForBattery();
            setupTripPlanning();
            
            // Load initial data
            if (userLocation) {
                // Load weather
                const weather = await getWeatherConditions(userLocation.lat, userLocation.lng);
                displayWeatherWidget(weather);
                
                // Load hazards
                const hazards = await new Promise(resolve => {
                    setTimeout(() => {
                        resolve([
                            {
                                id: '1',
                                type: 'no_streetlight',
                                severity: 'medium',
                                description: 'No street lights in this area after 10 PM',
                                lat: userLocation.lat + 0.005,
                                lng: userLocation.lng + 0.005,
                                timestamp: new Date().toISOString(),
                                verified: true,
                                verification_count: 3
                            },
                            {
                                id: '2',
                                type: 'broken_road',
                                severity: 'low',
                                description: 'Broken footpath near the market',
                                lat: userLocation.lat - 0.003,
                                lng: userLocation.lng - 0.004,
                                timestamp: new Date().toISOString(),
                                verified: false,
                                verification_count: 1
                            }
                        ]);
                    }, 1000);
                });
                
                hazardReports = hazards;
                hazards.forEach(hazard => displayCommunityHazard(hazard));
                
                // Update safety score
                const safetyScore = calculateAreaSafetyScore(userLocation.lat, userLocation.lng);
                document.getElementById('safetyScore').textContent = safetyScore;
                document.getElementById('activeReports').textContent = allReports.length;
            }
            
            // Setup privacy cleanup
            setInterval(cleanupOldData, 60 * 60 * 1000);
            
            // Show welcome message
            setTimeout(() => {
                showToast('üåç Enhanced SafeScape Ready! All features activated.');
            }, 1500);

            console.log('‚úÖ Enhanced SafeScape initialized successfully');
        }

        // ========================
        // üåê GLOBAL FUNCTIONS
        // ========================
        window.getDirectionsToSpot = function(lat, lon, spotName) {
            if (!userLocation) {
                showToast('üìç Please wait for location detection');
                return;
            }

            if (routeControl) {
                if (routeControl.line) map.removeLayer(routeControl.line);
                if (routeControl.startMarker) map.removeLayer(routeControl.startMarker);
                if (routeControl.endMarker) map.removeLayer(routeControl.endMarker);
                routeControl = null;
            }

            const routeLine = L.polyline([
                [userLocation.lat, userLocation.lng],
                [lat, lon]
            ], {
                color: '#667eea',
                weight: 6,
                opacity: 0.8,
                lineJoin: 'round'
            }).addTo(map);

            routeControl = {
                line: routeLine
            };

            showToast(`üìç Directions to ${spotName} activated`);
        };

        window.getDirections = function(lat, lon) {
            window.getDirectionsToSpot(lat, lon, 'selected location');
        };

        window.verifyHazardReport = function(hazardId) {
            showToast('‚úÖ Hazard report verified! Thank you for contributing to community safety.');
        };

        window.showEnhancedSafetyInfo = async function(lat, lng) {
            const safetyInfo = await getEnhancedSafetyScore(lat, lng);
            const safetyLevel = getSafetyLevel(safetyInfo.score);
            
            let weatherInfo = '';
            if (safetyInfo.weather) {
                weatherInfo = `
                    <p><strong>Weather:</strong> ${safetyInfo.weather.conditions}, ${Math.round(safetyInfo.weather.temperature)}¬∞C</p>
                    <p><strong>Visibility:</strong> ${(safetyInfo.weather.visibility / 1000).toFixed(1)} km</p>
                    <p><strong>Time:</strong> ${safetyInfo.weather.is_night ? 'üåô Night' : '‚òÄÔ∏è Day'}</p>
                `;
            }
            
            alert(`
                üõ°Ô∏è ENHANCED SAFETY ANALYSIS
                
                Safety Score: ${safetyInfo.score}/100
                ${safetyLevel.emoji} ${safetyLevel.level}
                
                ${weatherInfo}
                
                Breakdown:
                ‚Ä¢ Base Safety: ${safetyInfo.baseScore}
                ‚Ä¢ Time Impact: ${safetyInfo.timeModifier}
                ‚Ä¢ Weather Impact: ${safetyInfo.weather ? (safetyInfo.score - safetyInfo.baseScore - safetyInfo.timeModifier) : 'N/A'}
                
                Recommendations:
                ${getSafetyRecommendations(safetyInfo)}
            `);
        };

        function getSafetyRecommendations(safetyInfo) {
            const recommendations = [];
            
            if (safetyInfo.score < 40) {
                recommendations.push('‚Ä¢ Avoid this area if possible');
                recommendations.push('‚Ä¢ Travel with companions');
                recommendations.push('‚Ä¢ Share your live location');
            }
            
            if (safetyInfo.weather?.is_night) {
                recommendations.push('‚Ä¢ Use well-lit routes');
                recommendations.push('‚Ä¢ Stay in populated areas');
            }
            
            if (safetyInfo.weather?.conditions === 'Rain' || safetyInfo.weather?.conditions === 'Snow') {
                recommendations.push('‚Ä¢ Allow extra travel time');
                recommendations.push('‚Ä¢ Use main roads');
            }
            
            if (safetyInfo.weather?.visibility < 1000) {
                recommendations.push('‚Ä¢ Use high-visibility clothing');
                recommendations.push('‚Ä¢ Avoid walking near roads');
            }
            
            if (recommendations.length === 0) {
                recommendations.push('‚Ä¢ Normal precautions recommended');
                recommendations.push('‚Ä¢ Stay aware of surroundings');
            }
            
            return recommendations.join('\n');
        }

        window.callEmergency = callEmergency;
        
        window.callSpot = function(number) {
            if (number && number !== 'N/A') {
                if (confirm(`üìû Call ${number}?`)) {
                    window.location.href = `tel:${number}`;
                    showToast(`üìû Calling ${number}...`);
                }
            } else {
                showToast('‚ùå Contact number not available');
            }
        };
        
        function findNearestSpot() {
            if (!userLocation) {
                showToast('üìç Getting your location...');
                getUserLocation().then(() => findNearestSpot());
                return;
            }
            
            const spots = generateComprehensiveSafeSpots();
            const filteredSpots = applyAccessibilityFilters(spots);
            
            if (filteredSpots.length > 0) {
                const nearest = filteredSpots[0];
                map.setView([nearest.lat, nearest.lon], 16);
                
                // Create and show nearest spot marker
                const marker = L.marker([nearest.lat, nearest.lon], {
                    icon: L.divIcon({
                        className: 'nearest-spot-marker',
                        html: `<div style="background: ${getSpotColor(nearest.type)}; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 3px solid white; box-shadow: 0 3px 12px rgba(0,0,0,0.3); animation: pulse 2s infinite;">${getSpotIcon(nearest.type)}</div>`,
                        iconSize: [41, 41],
                        iconAnchor: [20, 20]
                    })
                }).addTo(map)
                .bindPopup(createSpotPopup(nearest, true))
                .openPopup();
                
                showToast(`üéØ Found nearest ${nearest.type}: ${nearest.name} (${nearest.distance}km)`);
            } else {
                showToast('‚ùå No spots found matching your criteria');
            }
        }
        
        function showAdvancedFilters() {
            alert(`üîç ADVANCED FILTERS\n\n‚úÖ Available Filters:\n‚Ä¢ Distance Range (1-25 km)\n‚Ä¢ Accessibility Features\n‚Ä¢ 24/7 Availability\n‚Ä¢ Women-Safe Locations\n‚Ä¢ Parking Availability\n\nüìù Use the checkboxes and dropdowns in the Find Safe Spots section to apply filters.\n\nüîÑ Filters are applied automatically when changed.`);
        }
        
        function saveCurrentSearch() {
            const searchData = {
                city: document.getElementById('citySelect').value,
                type: document.getElementById('typeFilter').value,
                distance: document.getElementById('distanceFilter').value,
                wheelchair: document.getElementById('wheelchair_access').checked,
                parking: document.getElementById('parking_available').checked,
                available24x7: document.getElementById('24x7_available').checked,
                femaleFriendly: document.getElementById('female_friendly').checked,
                timestamp: new Date().toISOString()
            };
            
            const savedSearches = JSON.parse(localStorage.getItem('safescape_saved_searches') || '[]');
            savedSearches.unshift(searchData);
            
            // Keep only last 5 searches
            if (savedSearches.length > 5) {
                savedSearches.splice(5);
            }
            
            localStorage.setItem('safescape_saved_searches', JSON.stringify(savedSearches));
            showToast('üîñ Search preferences saved!');
        }

        // Enhanced report validation
        function validateReportForm() {
            const errors = [];
            
            const issueType = document.getElementById('issueType').value;
            const description = document.getElementById('issueDescription').value.trim();
            
            if (!issueType) {
                errors.push('Please select an issue type');
            }
            
            if (!description) {
                errors.push('Please provide a description');
            } else if (description.length < 10) {
                errors.push('Description must be at least 10 characters');
            } else if (description.length > 500) {
                errors.push('Description must be less than 500 characters');
            }
            
            if (!selectedLocation) {
                errors.push('Please select a location for the report');
            }
            
            return errors;
        }
        
        // Real-time form validation
        function setupFormValidation() {
            const descriptionField = document.getElementById('issueDescription');
            if (descriptionField) {
                descriptionField.addEventListener('input', (e) => {
                    const length = e.target.value.length;
                    const counter = document.getElementById('descriptionCounter');
                    if (counter) {
                        counter.textContent = `${length}/500 characters`;
                        counter.style.color = length > 450 ? '#ff6b6b' : length < 10 ? '#ffa94d' : '#666';
                    }
                });
            }
        }

        // ========================
        // üöÄ ENHANCED QUICK ACTIONS
        // ========================
        
        function callEmergencyService(number, serviceName) {
            if (confirm(`üö® Call ${serviceName} (${number})?\n\nThis will initiate an emergency call. Make sure you have a genuine emergency.`)) {
                // Auto-share location if enabled
                if (userProfile.safetyPreferences.includes('auto_share_location')) {
                    startEnhancedLocationSharing();
                }
                
                // Simulate call (in real app, this would use tel: protocol)
                window.location.href = `tel:${number}`;
                showToast(`üìû Calling ${serviceName} (${number})...`);
                
                // Log emergency call
                logEmergencyAction('emergency_call', { service: serviceName, number: number });
            }
        }
        
        // Emergency service caller - globally available
        window.callEmergencyService = function(number, serviceName) {
            try {
                if (confirm(`üö® EMERGENCY CALL\n\nService: ${serviceName}\nNumber: ${number}\n\nThis will initiate an emergency call.\nProceed only if you have a genuine emergency.`)) {
                    // Auto-share location if enabled
                    if (userProfile?.safetyPreferences?.includes('auto_share_location')) {
                        startEnhancedLocationSharing();
                    }
                    
                    // Make actual call
                    window.location.href = `tel:${number}`;
                    showToast(`üìû Calling ${serviceName} (${number})...`);
                    
                    // Log emergency call
                    logEmergencyAction('emergency_call', { 
                        service: serviceName, 
                        number: number,
                        timestamp: new Date().toISOString(),
                        location: userLocation
                    });
                    
                    // Update emergency status
                    if (userProfile) {
                        userProfile.status = 'emergency';
                        updateStatusUI('emergency');
                        saveUserProfile();
                    }
                }
            } catch (error) {
                console.error('Emergency call error:', error);
                showToast('‚ùå Emergency call failed. Try dialing manually.');
            }
        };
        
        function activatePanicMode() {
            if (confirm('üö® ACTIVATE PANIC MODE?\n\nThis will:\n‚Ä¢ Send SOS alerts to emergency contacts\n‚Ä¢ Start continuous location sharing\n‚Ä¢ Activate audio recording\n‚Ä¢ Alert nearby SafeScape users\n\nOnly use in genuine emergencies!')) {
                userProfile.status = 'emergency';
                updateStatusUI('emergency');
                
                // Start panic mode features
                startPanicModeFeatures();
                showToast('üö® PANIC MODE ACTIVATED! Help is on the way.');
            }
        }
        
        async function startPanicModeFeatures() {
            // Show emergency status
            document.getElementById('emergencyStatus').style.display = 'block';
            
            // Start location sharing
            startEnhancedLocationSharing();
            
            // Simulate audio recording
            showToast('üé§ Audio recording started for evidence');
            
            // Alert nearby users
            setTimeout(() => {
                showToast('üì° Nearby SafeScape users have been alerted');
            }, 2000);
            
            // Send to emergency contacts
            if (userProfile.emergencyContacts.length > 0) {
                setTimeout(() => {
                    showToast(`üì± Emergency alerts sent to ${userProfile.emergencyContacts.length} contacts`);
                }, 3000);
            }
            
            // Log panic mode activation
            logEmergencyAction('panic_mode_activated', { timestamp: new Date().toISOString() });
        }
        
        function findSafestRoute() {
            const destination = prompt('üõ°Ô∏è Enter destination for safest route:');
            if (destination) {
                document.getElementById('routeTo').value = destination;
                document.getElementById('safetyPreference').value = 'safest';
                planRealRoute();
                showToast('üõ°Ô∏è Planning safest possible route...');
            }
        }
        
        async function findNearbyHelp() {
            if (!userLocation) {
                showToast('üìç Getting your location...');
                await getUserLocation();
            }
            
            showToast('üîç Finding nearby help and safe spots...');
            
            // Clear existing markers and show emergency services
            document.getElementById('typeFilter').value = 'emergency';
            document.getElementById('distanceFilter').value = '2';
            
            await findNearbySpots();
            await loadRealEmergencyServices();
            
            showToast('‚úÖ Nearby help locations displayed on map');
        }
        
        function performSafetyCheckIn() {
            const checkInModal = document.createElement('div');
            checkInModal.className = 'modal active';
            checkInModal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    <h2 class="modal-title">
                        <i class="fas fa-check-circle"></i>
                        Safety Check-in
                    </h2>
                    
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <p>Let your emergency contacts know you're safe!</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Current Status</label>
                        <select class="form-select" id="checkInStatus">
                            <option value="safe">‚úÖ I'm Safe</option>
                            <option value="delayed">‚è∞ Delayed but Safe</option>
                            <option value="help_needed">üÜò Need Help</option>
                            <option value="emergency">üö® Emergency</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Optional Message</label>
                        <textarea class="form-textarea" id="checkInMessage" placeholder="Add a message for your contacts..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="shareLocation" checked>
                            Share current location
                        </label>
                    </div>
                    
                    <button class="btn btn-primary" onclick="sendSafetyCheckIn()" style="width: 100%; margin-bottom: 0.5rem;">
                        <i class="fas fa-paper-plane"></i> Send Check-in
                    </button>
                    
                    <button class="btn btn-outline" onclick="this.closest('.modal').remove()" style="width: 100%;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(checkInModal);
        }
        
        window.sendSafetyCheckIn = function() {
            const status = document.getElementById('checkInStatus').value;
            const message = document.getElementById('checkInMessage').value;
            const shareLocation = document.getElementById('shareLocation').checked;
            
            // Update user status
            if (status === 'emergency') {
                userProfile.status = 'emergency';
                updateStatusUI('emergency');
                startPanicModeFeatures();
            } else if (status === 'help_needed') {
                userProfile.status = 'concern';
                updateStatusUI('concern');
            } else {
                userProfile.status = 'safe';
                updateStatusUI('safe');
            }
            
            // Simulate sending check-in
            const contactCount = userProfile.emergencyContacts.length;
            if (contactCount > 0) {
                showToast(`‚úÖ Safety check-in sent to ${contactCount} emergency contacts`);
            } else {
                showToast('‚úÖ Safety check-in recorded. Add emergency contacts in profile.');
            }
            
            // Log check-in
            logEmergencyAction('safety_checkin', {
                status: status,
                message: message,
                location_shared: shareLocation,
                timestamp: new Date().toISOString()
            });
            
            // Close modal
            document.querySelector('.modal.active').remove();
            
            saveUserProfile();
        };
        
        function logEmergencyAction(action, data) {
            try {
                const emergencyLog = JSON.parse(localStorage.getItem('safescape_emergency_log') || '[]');
                const logEntry = {
                    id: Date.now().toString(),
                    action: action,
                    data: data,
                    timestamp: new Date().toISOString(),
                    location: userLocation ? {
                        lat: userLocation.lat,
                        lng: userLocation.lng,
                        accuracy: userLocation.accuracy
                    } : null,
                    userAgent: navigator.userAgent,
                    sessionId: sessionStorage.getItem('safescape_session') || 'unknown'
                };
                
                emergencyLog.unshift(logEntry);
                
                // Keep only last 100 emergency actions
                if (emergencyLog.length > 100) {
                    emergencyLog.splice(100);
                }
                
                localStorage.setItem('safescape_emergency_log', JSON.stringify(emergencyLog));
                console.log('‚úÖ Emergency action logged:', action, logEntry);
                
                // Send to backend if available
                if (typeof fetch !== 'undefined') {
                    fetch('/api/log-emergency', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(logEntry)
                    }).catch(err => console.warn('Backend logging failed:', err));
                }
            } catch (error) {
                console.error('Emergency logging failed:', error);
            }
        }

        // Enhanced Emergency Contacts with Modal
        function showEmergencyContacts() {
            const city = document.getElementById('citySelect').value || 'delhi';
            const contacts = {
                'delhi': { police: '100', ambulance: '108', women_helpline: '1091', fire: '101', tourist: '1363', child: '1098' },
                'mumbai': { police: '100', ambulance: '108', women_helpline: '103', fire: '101', tourist: '1363', child: '1098' },
                'bangalore': { police: '100', ambulance: '108', women_helpline: '1091', fire: '101', tourist: '1363', child: '1098' },
                'jaipur': { police: '100', ambulance: '108', women_helpline: '1090', fire: '101', tourist: '1363', child: '1098' },
                'lucknow': { police: '100', ambulance: '108', women_helpline: '1090', fire: '101', tourist: '1363', child: '1098' },
                'gurugram': { police: '100', ambulance: '108', women_helpline: '1091', fire: '101', tourist: '1363', child: '1098' }
            };

            const cityContacts = contacts[city] || contacts.delhi;
            
            const contactsModal = document.createElement('div');
            contactsModal.className = 'modal active';
            contactsModal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    <h2 class="modal-title">
                        <i class="fas fa-phone-alt"></i>
                        Emergency Contacts - ${city.toUpperCase()}
                    </h2>
                    
                    <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="contact-card" style="background: #ff6b6b; color: white; padding: 1rem; border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; font-size: 1.1rem;">üöî Police</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Emergency & Crime</div>
                            </div>
                            <button onclick="callEmergencyService('${cityContacts.police}', 'Police')" style="background: white; color: #ff6b6b; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Call ${cityContacts.police}
                            </button>
                        </div>
                        
                        <div class="contact-card" style="background: #51cf66; color: white; padding: 1rem; border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; font-size: 1.1rem;">üöë Ambulance</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Medical Emergency</div>
                            </div>
                            <button onclick="callEmergencyService('${cityContacts.ambulance}', 'Ambulance')" style="background: white; color: #51cf66; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Call ${cityContacts.ambulance}
                            </button>
                        </div>
                        
                        <div class="contact-card" style="background: #ff922b; color: white; padding: 1rem; border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; font-size: 1.1rem;">üî• Fire Department</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Fire & Rescue</div>
                            </div>
                            <button onclick="callEmergencyService('${cityContacts.fire}', 'Fire Department')" style="background: white; color: #ff922b; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Call ${cityContacts.fire}
                            </button>
                        </div>
                        
                        <div class="contact-card" style="background: #e64980; color: white; padding: 1rem; border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; font-size: 1.1rem;">üë© Women Helpline</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Women Safety & Support</div>
                            </div>
                            <button onclick="callEmergencyService('${cityContacts.women_helpline}', 'Women Helpline')" style="background: white; color: #e64980; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Call ${cityContacts.women_helpline}
                            </button>
                        </div>
                        
                        <div class="contact-card" style="background: #4dabf7; color: white; padding: 1rem; border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; font-size: 1.1rem;">üß≥ Tourist Helpline</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Tourist Assistance</div>
                            </div>
                            <button onclick="callEmergencyService('${cityContacts.tourist}', 'Tourist Helpline')" style="background: white; color: #4dabf7; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Call ${cityContacts.tourist}
                            </button>
                        </div>
                        
                        <div class="contact-card" style="background: #9775fa; color: white; padding: 1rem; border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; font-size: 1.1rem;">üë∂ Child Helpline</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Child Safety & Support</div>
                            </div>
                            <button onclick="callEmergencyService('${cityContacts.child}', 'Child Helpline')" style="background: white; color: #9775fa; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Call ${cityContacts.child}
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--primary);">üì± Quick Tips:</h4>
                        <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                            <li>Save these numbers in your phone contacts</li>
                            <li>Share your location immediately when calling</li>
                            <li>Stay calm and speak clearly</li>
                            <li>Have your address ready</li>
                        </ul>
                    </div>
                    
                    <button class="btn btn-outline" onclick="this.closest('.modal').remove()" style="width: 100%;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            `;
            
            document.body.appendChild(contactsModal);
        }

        // Enhanced Safety Tips with Modal
        function showSafetyTips() {
            const tipsModal = document.createElement('div');
            tipsModal.className = 'modal active';
            tipsModal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    <h2 class="modal-title">
                        <i class="fas fa-lightbulb"></i>
                        Safety Tips & Guidelines
                    </h2>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        <div class="tip-category" style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem;">üåô Night Safety</h3>
                            <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                                <li>Always use well-lit, populated routes</li>
                                <li>Avoid shortcuts through dark alleys or isolated areas</li>
                                <li>Keep your phone flashlight ready</li>
                                <li>Walk confidently and stay alert</li>
                                <li>Use SafeScape's night mode routing</li>
                            </ul>
                        </div>
                        
                        <div class="tip-category" style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem;">üì± Technology Safety</h3>
                            <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                                <li>Keep your phone charged (carry power bank)</li>
                                <li>Share live location with trusted contacts</li>
                                <li>Use SafeScape's SOS feature in emergencies</li>
                                <li>Save emergency numbers in quick dial</li>
                                <li>Enable location services for safety apps</li>
                            </ul>
                        </div>
                        
                        <div class="tip-category" style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem;">üö∂ Personal Safety</h3>
                            <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                                <li>Trust your instincts - if something feels wrong, leave</li>
                                <li>Stay aware of your surroundings at all times</li>
                                <li>Avoid displaying expensive items publicly</li>
                                <li>Learn basic self-defense techniques</li>
                                <li>Travel in groups when possible</li>
                            </ul>
                        </div>
                        
                        <div class="tip-category" style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem;">üöó Transportation Safety</h3>
                            <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                                <li>Use licensed taxis and ride-sharing services</li>
                                <li>Verify vehicle details before getting in</li>
                                <li>Share trip details with someone you trust</li>
                                <li>Sit behind the driver in taxis</li>
                                <li>Keep doors locked during travel</li>
                            </ul>
                        </div>
                        
                        <div class="tip-category" style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem;">üë© Women's Safety</h3>
                            <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                                <li>Use women-only transport compartments when available</li>
                                <li>Keep women's helpline numbers handy</li>
                                <li>Inform someone about your travel plans</li>
                                <li>Carry a whistle or personal alarm</li>
                                <li>Use SafeScape's women-safe route options</li>
                            </ul>
                        </div>
                        
                        <div class="tip-category">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem;">üÜò Emergency Preparedness</h3>
                            <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                                <li>Memorize important emergency numbers</li>
                                <li>Keep emergency contacts updated</li>
                                <li>Know your blood type and medical conditions</li>
                                <li>Carry emergency cash and ID</li>
                                <li>Practice using SafeScape's SOS feature</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: center;">
                        <strong style="color: #2d5016;">üõ°Ô∏è Remember: Your safety is our priority!</strong>
                    </div>
                    
                    <button class="btn btn-outline" onclick="this.closest('.modal').remove()" style="width: 100%;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            `;
            
            document.body.appendChild(tipsModal);
        }

        // Enhanced Accessibility Info with Modal
        function showAccessibilityInfo() {
            const accessibilityModal = document.createElement('div');
            accessibilityModal.className = 'modal active';
            accessibilityModal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    <h2 class="modal-title">
                        <i class="fas fa-wheelchair"></i>
                        Accessibility Features
                    </h2>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        <div class="accessibility-feature" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--primary);">‚ôø Mobility Assistance</h4>
                            <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                                <li>Wheelchair-accessible route planning</li>
                                <li>Ramp and elevator location mapping</li>
                                <li>Barrier-free path recommendations</li>
                                <li>Accessible parking spot identification</li>
                                <li>Step-free access to buildings</li>
                            </ul>
                        </div>
                        
                        <div class="accessibility-feature" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--primary);">üëÅÔ∏è Visual Assistance</h4>
                            <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                                <li>Voice-guided navigation</li>
                                <li>High contrast mode for better visibility</li>
                                <li>Audio descriptions of surroundings</li>
                                <li>Tactile pathway information</li>
                                <li>Screen reader compatibility</li>
                            </ul>
                        </div>
                        
                        <div class="accessibility-feature" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--primary);">üëÇ Hearing Assistance</h4>
                            <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                                <li>Visual alerts and notifications</li>
                                <li>Text-based emergency communication</li>
                                <li>Vibration alerts for important updates</li>
                                <li>Sign language interpreter locations</li>
                                <li>Hearing loop facility information</li>
                            </ul>
                        </div>
                        
                        <div class="accessibility-feature" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--primary);">üß† Cognitive Assistance</h4>
                            <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                                <li>Simple, clear navigation instructions</li>
                                <li>Landmark-based directions</li>
                                <li>Reduced cognitive load interface</li>
                                <li>Emergency contact quick access</li>
                                <li>Routine and familiar route suggestions</li>
                            </ul>
                        </div>
                        
                        <div class="accessibility-feature" style="background: #e8f5e8; padding: 1rem; border-radius: 8px;">
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--success);">üîß Customization Options</h4>
                            <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                                <li>Personalized accessibility profiles</li>
                                <li>Custom route preferences</li>
                                <li>Adjustable interface elements</li>
                                <li>Accessibility barrier reporting</li>
                                <li>Community-driven accessibility data</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: center;">
                        <strong style="color: #856404;">üí° Tip: Enable accessibility features in your profile settings for a personalized experience!</strong>
                    </div>
                    
                    <button class="btn btn-primary" onclick="showProfileEditView(); this.closest('.modal').remove();" style="width: 100%; margin-bottom: 0.5rem;">
                        <i class="fas fa-cog"></i> Configure Accessibility Settings
                    </button>
                    
                    <button class="btn btn-outline" onclick="this.closest('.modal').remove()" style="width: 100%;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            `;
            
            document.body.appendChild(accessibilityModal);
        }

        // ========================
        // üèÅ START APPLICATION
        // ========================
        init();
    });
  </script>
</body>
</html>